<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://luqingbys.github.io/mid-lake-pavilion.github.io/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/mid-lake-pavilion.github.io/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/mid-lake-pavilion.github.io/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/mid-lake-pavilion.github.io/css/style.css">

  
    
<link rel="stylesheet" href="/mid-lake-pavilion.github.io/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.1.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/mid-lake-pavilion.github.io/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/mid-lake-pavilion.github.io/">Home</a>
        
          <a class="main-nav-link" href="/mid-lake-pavilion.github.io/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/mid-lake-pavilion.github.io/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://luqingbys.github.io/mid-lake-pavilion.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-关系代数" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/mid-lake-pavilion.github.io/2022/03/07/%E5%85%B3%E7%B3%BB%E4%BB%A3%E6%95%B0/" class="article-date">
  <time class="dt-published" datetime="2022-03-07T12:07:39.000Z" itemprop="datePublished">2022-03-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/mid-lake-pavilion.github.io/2022/03/07/%E5%85%B3%E7%B3%BB%E4%BB%A3%E6%95%B0/">关系代数</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="元组关系演算"><a href="#元组关系演算" class="headerlink" title="元组关系演算"></a>元组关系演算</h2><h3 id="基本形式"><a href="#基本形式" class="headerlink" title="基本形式"></a>基本形式</h3><p><code>&#123;t | P(t)&#125;</code></p>
<p>也就是说，在上面的元组关系演算中，基本单元为元组t，P是谓词，所有使得该谓词为真的元组组成了这个集合。</p>
<h3 id="几个记号"><a href="#几个记号" class="headerlink" title="几个记号"></a>几个记号</h3><ul>
<li>t是元组变量，t[A]表示t在属性A上的值</li>
<li>t属于R，表示元组t属于关系R</li>
</ul>
<h2 id="域关系演算"><a href="#域关系演算" class="headerlink" title="域关系演算"></a>域关系演算</h2><p>域变量是表示域的变量。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://luqingbys.github.io/mid-lake-pavilion.github.io/2022/03/07/%E5%85%B3%E7%B3%BB%E4%BB%A3%E6%95%B0/" data-id="cl17apw2a001vicud3rpy22yl" data-title="关系代数" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Vue3移动图书商城项目实战" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/mid-lake-pavilion.github.io/2022/03/04/Vue3%E7%A7%BB%E5%8A%A8%E5%9B%BE%E4%B9%A6%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" class="article-date">
  <time class="dt-published" datetime="2022-03-04T09:02:06.000Z" itemprop="datePublished">2022-03-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/mid-lake-pavilion.github.io/2022/03/04/Vue3%E7%A7%BB%E5%8A%A8%E5%9B%BE%E4%B9%A6%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/">Vue3移动图书商城项目实战</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h1><p>src目录下建立了各个文件夹，便于分类存放各种文件：</p>
<ul>
<li>assets：静态资源文件夹，包括css、图片资源等；</li>
<li>components：通用组件文件夹，存放一些通用的、耦合性低的组件文件；</li>
<li>network：封装网络请求的文件夹，前端项目中不可避免地会调用后台接口，这个文件夹中存放此类文件，管理接口调用；</li>
<li>router：路由配置文件夹；</li>
<li>store：Vuex文件夹，一般会有多个文件，用于分模块共享数据；</li>
<li>utils：存放第三方库的文件；</li>
<li>views：页面级别的组件存放文件夹；</li>
</ul>
<h2 id="配置network接口文件夹"><a href="#配置network接口文件夹" class="headerlink" title="配置network接口文件夹"></a>配置network接口文件夹</h2><p>在network文件夹下建立三个文件：</p>
<ul>
<li>cart.js</li>
<li>home.js：包含获取首页所有数据的接口调用</li>
<li>request.js：管理所有的接口调用，比如请求拦截、响应拦截等</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request.js</span></span><br><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">&#x27;axios&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">config</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> instance = axios.<span class="title function_">create</span>(&#123;</span><br><span class="line">        <span class="attr">baseURL</span>: <span class="string">&#x27;http://api.shop.eduwork.cn&#x27;</span>,</span><br><span class="line">        <span class="attr">timeout</span>: <span class="number">5000</span>,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求拦截</span></span><br><span class="line">    instance.<span class="property">interceptors</span>.<span class="property">request</span>.<span class="title function_">use</span>(<span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 如果有一个接口需要认证才可以访问，就在这里统一设置</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> config</span><br><span class="line">    &#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 响应拦截</span></span><br><span class="line">    instance.<span class="property">interceptors</span>.<span class="property">response</span>.<span class="title function_">use</span>(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    &#125;, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 如果有需要授权才可以访问的接口，统一去login授权</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果有错误，这里会进行处理</span></span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">instance</span>(config)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于我们接下来第一个要实现的就是首页功能，因此，我们需要先配置好首页中接口调用函数，放在home.js文件中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// home.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; request &#125; <span class="keyword">from</span> <span class="string">&quot;./request&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getHomeAllData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">        <span class="comment">// 拿到首页所有数据，无需任何参数，所以只提供url就可以</span></span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;/api/index&#x27;</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="小试牛刀：获取首页所有数据"><a href="#小试牛刀：获取首页所有数据" class="headerlink" title="小试牛刀：获取首页所有数据"></a>小试牛刀：获取首页所有数据</h2><p>我们在Home.vue组件中获取数据，在setup函数中调用onMounted生命周期钩子，希望在页面加载时就将拿到的数据显示到页面，故在该钩子中发起axios请求获取数据：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> banner = <span class="title function_">ref</span>([])</span><br><span class="line">    <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">getHomeAllData</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;&#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">err</span>) =&gt;</span> &#123;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      banner,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置路由"><a href="#配置路由" class="headerlink" title="配置路由"></a>配置路由</h2><p>我们在views目录下创建所有页面级的文件夹，用于存放各个页面功能的组件：</p>
<ul>
<li>category：商品分类页面</li>
<li>detail：商品详情页面</li>
<li>home：主页</li>
<li>profile：个人中心页面</li>
<li>shopcart：购物车页面</li>
</ul>
<p>在配置路由之前，为了使得路由跳转效果明显，我们需要建立以上各个页面的组件文件，比如category文件夹下建立Category.vue文件，其中简单写几句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;商品分类&lt;/h1&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;</span><br><span class="line"></span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>接下来我们在router文件夹下的index.js文件中设置路由。</p>
<p>首先，为了实现懒加载，我们先导入各个组件文件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">Home</span> = (<span class="params"></span>) =&gt; <span class="title function_">import</span>(<span class="string">&#x27;../views/home/Home.vue&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Category</span> = (<span class="params"></span>) =&gt; <span class="title function_">import</span>(<span class="string">&#x27;../views/category/Category.vue&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Detail</span> = (<span class="params"></span>) =&gt; <span class="title function_">import</span>(<span class="string">&#x27;../views/detail/Detail.vue&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">Profile</span> = (<span class="params"></span>) =&gt; <span class="title function_">import</span>(<span class="string">&#x27;../views/profile/Profile.vue&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ShopCart</span> = (<span class="params"></span>) =&gt; <span class="title function_">import</span>(<span class="string">&#x27;../views/shopcart/ShopCart.vue&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>其次，在routes数组中补充路由配置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;DefaultHome&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Home</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/home&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Home&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Home</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/category&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Category&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Category</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/detail&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Detail&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Detail</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/shopcart&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;ShopCart&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">ShopCart</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>: <span class="string">&#x27;/profile&#x27;</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Profile&#x27;</span>,</span><br><span class="line">    <span class="attr">component</span>: <span class="title class_">Profile</span></span><br><span class="line">  &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<h2 id="制作导航栏"><a href="#制作导航栏" class="headerlink" title="制作导航栏"></a>制作导航栏</h2><p>该移动端移动图书商城的导航栏在最底层，分为四个选项“首页-分类-购物车-我的”，因此，我们直接在App.vue组件中实现。</p>
<p>在阿里下载好图标后，导入到页面中，由于路由跳转在上面已经实现，故接下来关键只剩两步了：</p>
<ul>
<li>使用flex布局使四个选项在同一行均匀显示，呈现分栏状；</li>
<li>使用fixed定位，将导航栏置于页面最底部。</li>
</ul>
<p>App.vue组件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">    &lt;router-view /&gt;</span><br><span class="line">    &lt;div id=&quot;nav&quot;&gt;</span><br><span class="line">      &lt;router-link class=&quot;tab-bar-item&quot; to=&quot;/&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;icon&quot;&gt;&lt;i class=&quot;iconfont icon-shouye&quot;&gt;&lt;/i&gt;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;首页&lt;/div&gt;</span><br><span class="line">      &lt;/router-link&gt;</span><br><span class="line">      &lt;router-link class=&quot;tab-bar-item&quot; to=&quot;/category&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;icon&quot;&gt;&lt;i class=&quot;iconfont icon-fenlei&quot;&gt;&lt;/i&gt;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;分类&lt;/div&gt;</span><br><span class="line">      &lt;/router-link&gt;</span><br><span class="line">      &lt;router-link class=&quot;tab-bar-item&quot; to=&quot;/shopcart&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;icon&quot;&gt;&lt;i class=&quot;iconfont icon-gouwuche&quot;&gt;&lt;/i&gt;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;购物车&lt;/div&gt;</span><br><span class="line">      &lt;/router-link&gt;</span><br><span class="line">      &lt;router-link class=&quot;tab-bar-item&quot; to=&quot;/profile&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;icon&quot;&gt;&lt;i class=&quot;iconfont icon-xiazai&quot;&gt;&lt;/i&gt;&lt;/div&gt;</span><br><span class="line">        &lt;div&gt;我的&lt;/div&gt;</span><br><span class="line">      &lt;/router-link&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;style lang=&quot;scss&quot;&gt;</span><br><span class="line">@import &#x27;assets/css/base.css&#x27;;</span><br><span class="line">@import &#x27;assets/css/iconfont.css&#x27;;</span><br><span class="line">#app &#123;</span><br><span class="line">  font-family: Avenir, Helvetica, Arial, sans-serif;</span><br><span class="line">  -webkit-font-smoothing: antialiased;</span><br><span class="line">  -moz-osx-font-smoothing: grayscale;</span><br><span class="line">  text-align: center;</span><br><span class="line">  color: #2c3e50;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#nav &#123;</span><br><span class="line">  background-color: #f6f6f6;</span><br><span class="line">  display: flex;</span><br><span class="line">  position: fixed;</span><br><span class="line">  left: 0;</span><br><span class="line">  right: 0;</span><br><span class="line">  bottom: 0;</span><br><span class="line">  box-shadow: 0 -3px 1px rgba(100, 100, 100, 0.1);</span><br><span class="line">  a &#123;</span><br><span class="line">    color: var(--color-text);</span><br><span class="line"></span><br><span class="line">    &amp;.router-link-exact-active &#123;</span><br><span class="line">      color: #42b983;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  .tab-bar-item &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    text-align: center;</span><br><span class="line">    height: 50px;</span><br><span class="line">    font-size: var(--font-size);</span><br><span class="line">  &#125;</span><br><span class="line">  .tab-bar-item .icon &#123;</span><br><span class="line">    width: 24px;</span><br><span class="line">    height: 24px;</span><br><span class="line">    margin-top: 3px;</span><br><span class="line">    display: inline-block;</span><br><span class="line">    vertical-align: middle;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="首页推荐商品组件的实现"><a href="#首页推荐商品组件的实现" class="headerlink" title="首页推荐商品组件的实现"></a>首页推荐商品组件的实现</h2><p>首页推荐商品组件，即四本横向排列的书籍，我们单独把这一部分作为一个组件（.vue）来实现。</p>
<p>在view文件夹的home&#x2F;ChildComps文件夹下新建Recommend.vue文件，视图部分肯定要用到flex布局：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--Recommend.vue--&gt;</span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;recommend&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;recommend-item&quot; v-for=&quot;item in recommends.slice(0, 4)&quot; :key=&quot;item.id&quot;&gt;</span><br><span class="line">          &lt;a href=&quot;&quot; @click.prevent=&quot;goD(item.id)&quot;&gt;</span><br><span class="line">              &lt;img src=&quot;~assets/images/youshi1.png&quot; alt=&quot;&quot;&gt;</span><br><span class="line">              &lt;div&gt;&#123;&#123; item.title &#125;&#125;&lt;/div&gt;</span><br><span class="line">          &lt;/a&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;style lang=&quot;scss&quot; scoped&gt;</span><br><span class="line">.recommend &#123;</span><br><span class="line">    display: flex;</span><br><span class="line">    width: 100%;</span><br><span class="line">    text-align: center;</span><br><span class="line">    padding: 15px 0 30px;</span><br><span class="line">    border-bottom: 8px solid #eee;</span><br><span class="line">    font-size: 12px;</span><br><span class="line">&#125;</span><br><span class="line">.recommend-item &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    img &#123;</span><br><span class="line">        width: 70px;</span><br><span class="line">        height: 70px;</span><br><span class="line">        margin-bottom: 10px;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>数据来自网络请求，也即获取首页数据，这网络请求的相关代码已经封装在了network&#x2F;home.js中了；我们在Home组件中发起请求，获取首页中需要的全部信息，然后<strong>将推荐的书籍信息传递给Recommend子组件</strong>——使用props属性。</p>
<h3 id="props用法"><a href="#props用法" class="headerlink" title="props用法"></a>props用法</h3><p>在vue3中，父组件传递数据给子组件，需要用到props。而父组件传过来的数据，子组件的模板、setup函数中的引入方式略有不同。</p>
<h4 id="模板使用props"><a href="#模板使用props" class="headerlink" title="模板使用props"></a>模板使用props</h4><p>与setup同级使用props配置项即可。此时，也有两种常见的用法：</p>
<ul>
<li><p>字符串数组写法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">    props: [&#x27;title&#x27;, &#x27;author&#x27;],</span><br><span class="line">    setup() &#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>上面的props配置项数组中，每一个字符串中的内容都是父组件传来的数据变量名（title，author）。</p>
</li>
<li><p>对象写法</p>
<p>对象写法允许我们在指定传来的属性名同时，指定它需要传递的类型，以及是否必需，默认值等等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">    props: &#123;</span><br><span class="line">        title: &#123;</span><br><span class="line">            type: String,</span><br><span class="line">            required: true,</span><br><span class="line">        &#125;,</span><br><span class="line">        author: &#123;</span><br><span class="line">            type: String,</span><br><span class="line">            default() &#123;</span><br><span class="line">                return &#x27;&#x27;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="setup函数使用props"><a href="#setup函数使用props" class="headerlink" title="setup函数使用props"></a>setup函数使用props</h4><p>setup函数接收两个参数props，context，其中第一个参数就可以接收到父组件传来的数据，以供在setup函数中使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">export default &#123;</span><br><span class="line">    setup(props, context) &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>



<h2 id="首页选项卡的实现"><a href="#首页选项卡的实现" class="headerlink" title="首页选项卡的实现"></a>首页选项卡的实现</h2><p>注意到首页的选项卡并不是首页独有的，而是出现在多个组件中的，因此可以作为公用组件出现在components目录下：在components&#x2F;common下新建tabControl文件夹，在其中新建tabControl.vue文件，用于制作选项卡。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div class=&quot;tab-control&quot;&gt;</span><br><span class="line">    &lt;div</span><br><span class="line">      class=&quot;tab-control-item&quot;</span><br><span class="line">      v-for=&quot;(item, index) in titles&quot;</span><br><span class="line">      :key=&quot;index&quot;</span><br><span class="line">      @click=&quot;itemClick(index)&quot;</span><br><span class="line">      :class=&quot;&#123; active: index==currentIndex &#125;&quot;</span><br><span class="line">    &gt;</span><br><span class="line">      &lt;span&gt;&#123;&#123; item &#125;&#125;&lt;/span&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">  name: &#x27;TabControl&#x27;,</span><br><span class="line">  props: &#123;</span><br><span class="line">    titles: &#123;</span><br><span class="line">      type: Array,</span><br><span class="line">      default() &#123;</span><br><span class="line">        return []</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  setup() &#123;</span><br><span class="line">    let currentIndex = ref(0)</span><br><span class="line">    // 当点击某一个选项卡时，把active类赋给它</span><br><span class="line">    const itemClick = (index) =&gt; &#123;</span><br><span class="line">        currentIndex.value = index</span><br><span class="line">    &#125;</span><br><span class="line">    return &#123;</span><br><span class="line">      currentIndex,</span><br><span class="line">      itemClick,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped lang=&quot;scss&quot;&gt;</span><br><span class="line">.tab-control &#123;</span><br><span class="line">  display: flex;</span><br><span class="line">  height: 40px;</span><br><span class="line">  line-height: 40px;</span><br><span class="line">  text-align: center;</span><br><span class="line">  font-size: 14px;</span><br><span class="line">  width: 100%;</span><br><span class="line">  .tab-control-item &#123;</span><br><span class="line">    flex: 1;</span><br><span class="line">    span &#123;</span><br><span class="line">      padding: 5px;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  .active &#123;</span><br><span class="line">    color: var(--color-tint);</span><br><span class="line">    span &#123;</span><br><span class="line">      border-bottom: 3px solid var(--color-tint);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>虽然首页中的选项卡只有三项，但是其他组件中的选项卡跟首页并不相同，因此使用组件传值的方式，用变量接收选项卡数据，同时使用v-for指令动态生成若干选项卡。</p>
<p>样式方面，对选项卡进行flex布局设置，另外，由于点击某一个选项卡会触发特殊样式，因此对样式使用属性绑定写法：</p>
<p><code>:class=&quot;&#123; active: index==currentIndex &#125;&quot;</code></p>
<p>而currentIndex是设置的标记变量，用于记录当前被点击的选项卡序号，index是每一个选项卡固有的序号属性，两者比对即可实现对样式是否触发的检验。</p>
<p>接下来，我们需要实现点击某一个选项卡后，显示该项下的内容。由于选项卡是子组件TabControl.vue实现的，但是该选项卡要展示的内容却是在Home组件中显示的，因此涉及了子组件向父组件传递数据。</p>
<h3 id="emit"><a href="#emit" class="headerlink" title="emit"></a>emit</h3><p>emit可以实现子组件与父组件的通信。emit（触发），当子组件中完成某个操作时，调用回调函数，触发（emit）一个自定义事件，该API可以携带多个需要传给父组件的参数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 子组件中的JavaScript代码片段</span></span><br><span class="line"><span class="title function_">setup</span>(<span class="params">props, &#123; emit &#125;</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> currentIndex = <span class="title function_">ref</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="comment">// 当点击某一个选项卡时，把active类赋给它，并触发tabClick事件</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">itemClick</span> = (<span class="params">index</span>) =&gt; &#123;</span><br><span class="line">        currentIndex.<span class="property">value</span> = index</span><br><span class="line">        <span class="title function_">emit</span>(<span class="string">&#x27;tabClick&#x27;</span>, index)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      currentIndex,</span><br><span class="line">      itemClick,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<p>接下来把目光转移到父组件：</p>
<p>在父组件中，我们需要自定义上述事件（即自定义事件），并给该自定义事件绑定一个回调函数，它可以以参数形式接收子组件传来的数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;div&gt;</span><br><span class="line">      ...</span><br><span class="line">      &lt;TabControl @tabClick=&quot;tabClick&quot; :titles=&quot;[&#x27;畅销&#x27;, &#x27;新书&#x27;, &#x27;精选&#x27;]&quot;&gt;&lt;/TabControl&gt;</span><br><span class="line">  &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">...</span><br><span class="line">export default &#123;</span><br><span class="line">    name: &#x27;Home&#x27;,</span><br><span class="line">    components: &#123;</span><br><span class="line">        NavBar,</span><br><span class="line">        Recommend,</span><br><span class="line">        TabControl,</span><br><span class="line">    &#125;,</span><br><span class="line">    setup() &#123;</span><br><span class="line">        ...</span><br><span class="line">        const tabClick = (index) =&gt; &#123;</span><br><span class="line">            console.log(index);</span><br><span class="line">        &#125;</span><br><span class="line">        return &#123;</span><br><span class="line">            ...,</span><br><span class="line">            tabClick,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style scoped&gt;</span><br><span class="line">.banners img &#123;</span><br><span class="line">    width: 100%;</span><br><span class="line">    height: auto;</span><br><span class="line">    margin-top: 45px;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>



<h2 id="首页选项卡数据切换"><a href="#首页选项卡数据切换" class="headerlink" title="首页选项卡数据切换"></a>首页选项卡数据切换</h2><p>首页组件（Home.vue）中获取后台数据涉及了三个接口，于是在首页组件中定义一个goods对象，用它保存首页选项卡三个选项各自对应的数据（畅销、新书、精选），而上面已经实现了子组件将被点击的选项序号传递给父组件，故在父组件中，只需要实现将对应的数据再传给子组件即可。</p>
<p>分析父组件的JavaScript代码块：</p>
<p>首先，有一个变量保存当前点击的选项卡内容；</p>
<p><code>let currentType = ref(&#39;sales&#39;)</code></p>
<p>我们把目光再次回到之前定义过的tabClick回调函数（点击选项卡时触发）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">tabClick</span> = (<span class="params">index</span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(index)</span><br><span class="line">  <span class="keyword">let</span> types = [<span class="string">&#x27;sales&#x27;</span>, <span class="string">&#x27;new&#x27;</span>, <span class="string">&#x27;recommend&#x27;</span>]</span><br><span class="line">  currentType.<span class="property">value</span> = types[index]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，这个tabClick函数就是Home父组件中自定义事件tabClick绑定的回调函数。</p>
<p>获取三个选项卡需要的后台数据，也即发送三个网络请求，并保存结果，当然在此之前，需要在network文件夹下的home.js文件中封装好相关的网络请求函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// network/home.js</span></span><br><span class="line"><span class="comment">// 获取首页三个选项卡涉及的所有商品数据</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">getHomeGoods</span>(<span class="params">type=<span class="string">&#x27;sales&#x27;</span>, page=<span class="number">1</span></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;/api/index?&#x27;</span>+type+<span class="string">&#x27;=1&amp;page=&#x27;</span>+page</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就可以在Home组件中使用了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Home.vue中的JavaScript代码</span></span><br><span class="line"><span class="comment">// 商品列表数据模型</span></span><br><span class="line"><span class="keyword">const</span> goods = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">  <span class="attr">sales</span>: &#123;</span><br><span class="line">    <span class="attr">page</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">list</span>: [],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">new</span>: &#123;</span><br><span class="line">    <span class="attr">page</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">list</span>: [],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">recommend</span>: &#123;</span><br><span class="line">    <span class="attr">page</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">list</span>: [],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 用于记录当前点击的选项卡内容</span></span><br><span class="line"><span class="keyword">let</span> currentType = <span class="title function_">ref</span>(<span class="string">&#x27;sales&#x27;</span>)</span><br><span class="line"><span class="comment">// 展示当前点击的选项卡的数据，发送给子组件</span></span><br><span class="line"><span class="keyword">const</span> showGoods = <span class="title function_">computed</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> goods[currentType.<span class="property">value</span>].<span class="property">list</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title function_">getHomeAllData</span>().<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    recommends.<span class="property">value</span> = res.<span class="property">goods</span>.<span class="property">data</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 按销量排行</span></span><br><span class="line">  <span class="title function_">getHomeGoods</span>(<span class="string">&#x27;sales&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    goods.<span class="property">sales</span>.<span class="property">list</span> = res.<span class="property">goods</span>.<span class="property">data</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 按推荐排行</span></span><br><span class="line">  <span class="title function_">getHomeGoods</span>(<span class="string">&#x27;recommend&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    goods.<span class="property">recommend</span>.<span class="property">list</span> = res.<span class="property">goods</span>.<span class="property">data</span></span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="comment">// 按新品排行</span></span><br><span class="line">  <span class="title function_">getHomeGoods</span>(<span class="string">&#x27;new&#x27;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    goods.<span class="property">new</span>.<span class="property">list</span> = res.<span class="property">goods</span>.<span class="property">data</span></span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h2 id="上拉加载更多数据"><a href="#上拉加载更多数据" class="headerlink" title="上拉加载更多数据"></a>上拉加载更多数据</h2><p>需要用到移动端滚动条的第三方库——BetterScroll。</p>
<p>在首页的选项卡中，由于是移动端，不可能像PC端点击分页器获取更多数据，而是通过往上滑动，加载更多数据，因此，需要对滑动事件进行优化、处理（绑定网络请求）。Home组件的JavaScript代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//   创建BetterScroll对象</span></span><br><span class="line">bscroll = <span class="keyword">new</span> <span class="title class_">BScroll</span>(<span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.wrapper&#x27;</span>), &#123;</span><br><span class="line">  <span class="attr">probeType</span>: <span class="number">3</span>, <span class="comment">// 只要在运动，就触发scroll事件</span></span><br><span class="line">  <span class="attr">click</span>: <span class="literal">true</span>, <span class="comment">// 是否允许点击</span></span><br><span class="line">  <span class="attr">pullUpLoad</span>: <span class="literal">true</span>, <span class="comment">// 是否上拉加载更多，true为是</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//   绑定滚动的回调函数</span></span><br><span class="line">bscroll.<span class="title function_">on</span>(<span class="string">&#x27;scroll&#x27;</span>, <span class="function">(<span class="params">position</span>) =&gt;</span> &#123;&#125;)</span><br><span class="line"><span class="comment">//   上拉加载数据，触发pullingUp</span></span><br><span class="line">bscroll.<span class="title function_">on</span>(<span class="string">&#x27;pullingUp&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;加载更多&#x27;</span>)</span><br><span class="line">  bscroll.<span class="title function_">refresh</span>()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="上拉情况下的导航条固定"><a href="#上拉情况下的导航条固定" class="headerlink" title="上拉情况下的导航条固定"></a>上拉情况下的导航条固定</h2><p>由于首页的选项卡组件使用了固定定位，但是这是当往下滑动时候的布局样式（一直往下滑动获取新的书籍信息时，此时选项卡固定在页面最上方），对此，我们单独再复制一份选项卡组件，使用v-show指定控制它的显示与否；而显示条件需要我们获取到临界高度，一旦大于这个高度时，就让组件固定展示。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Home.vue中的JavaScript代码片段</span></span><br><span class="line"><span class="comment">// 控制选项卡是否被固定</span></span><br><span class="line"><span class="keyword">let</span> isTabFixed = <span class="title function_">ref</span>(<span class="literal">false</span>)</span><br><span class="line"><span class="comment">//   绑定滚动的回调函数</span></span><br><span class="line">bscroll.<span class="title function_">on</span>(<span class="string">&#x27;scroll&#x27;</span>, <span class="function">(<span class="params">position</span>) =&gt;</span> &#123;</span><br><span class="line">  isTabFixed.<span class="property">value</span> = -position.<span class="property">y</span>&gt;banref.<span class="property">value</span>.<span class="property">offsetHeight</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://luqingbys.github.io/mid-lake-pavilion.github.io/2022/03/04/Vue3%E7%A7%BB%E5%8A%A8%E5%9B%BE%E4%B9%A6%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" data-id="cl17apw23001eicud0fsi0cvw" data-title="Vue3移动图书商城项目实战" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Vue3-TypeScript项目实战自练" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/mid-lake-pavilion.github.io/2022/03/01/Vue3-TypeScript%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E8%87%AA%E7%BB%83/" class="article-date">
  <time class="dt-published" datetime="2022-03-01T15:19:18.000Z" itemprop="datePublished">2022-03-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/mid-lake-pavilion.github.io/2022/03/01/Vue3-TypeScript%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E8%87%AA%E7%BB%83/">Vue3+TypeScript项目实战自练</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="项目开启"><a href="#项目开启" class="headerlink" title="项目开启"></a>项目开启</h2><p>技术栈：Vite，Vue，TypeScript，Element UI Plus</p>
<p>开发工具：VScode</p>
<p>在项目中新建router文件夹，其下新建目录index.ts文件，内容如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createRouter, createWebHistory, <span class="title class_">RouteRecordRaw</span> &#125; <span class="keyword">from</span> <span class="string">&quot;vue-router&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Layout</span> <span class="keyword">from</span> <span class="string">&#x27;@/components/HelloWorld.vue&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="attr">routes</span>: <span class="title class_">Array</span>&lt;<span class="title class_">RouteRecordRaw</span>&gt; = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;home&#x27;</span>,</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">Layout</span>,</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment">// 创建</span></span><br><span class="line"><span class="keyword">const</span> router = <span class="title function_">createRouter</span>(&#123;</span><br><span class="line">    <span class="attr">history</span>: <span class="title function_">createWebHistory</span>(),</span><br><span class="line">    routes</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> router</span><br></pre></td></tr></table></figure>



<h2 id="整合store"><a href="#整合store" class="headerlink" title="整合store"></a>整合store</h2><p>npm安装好vuex后，我们新建store文件夹，在该目录下新建index.ts文件，放入官网代码，进行测试。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// store.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">InjectionKey</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, useStore <span class="keyword">as</span> baseUseStore, <span class="title class_">Store</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">State</span> &#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> <span class="attr">key</span>: <span class="title class_">InjectionKey</span>&lt;<span class="title class_">Store</span>&lt;<span class="title class_">State</span>&gt;&gt; = <span class="title class_">Symbol</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> store = createStore&lt;<span class="title class_">State</span>&gt;(&#123;</span><br><span class="line">  <span class="attr">state</span>: &#123;</span><br><span class="line">    <span class="attr">count</span>: <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">mutations</span>: &#123;</span><br><span class="line">      <span class="title function_">setCount</span>(<span class="params">state: State, count: <span class="built_in">number</span></span>) &#123;</span><br><span class="line">          state.<span class="property">count</span> = count</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">getters</span>: &#123;</span><br><span class="line">      <span class="title function_">getCount</span>(<span class="params">state: State</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> state.<span class="property">count</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义自己的 `useStore` 组合式函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">useStore</span> () &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">baseUseStore</span>(key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了检验vuex的导入情况，我们在HelloWorld.vue中进行测试：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123; ref, computed &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; useStore &#125; from &#x27;../store&#x27;</span><br><span class="line"></span><br><span class="line">// 接收store</span><br><span class="line">const store = useStore()</span><br><span class="line">// 通过计算属性得到store中的count属性</span><br><span class="line">const showCount = computed(() =&gt; &#123;</span><br><span class="line">  return store.getters[&#x27;getCount&#x27;]</span><br><span class="line">&#125;)</span><br><span class="line">const addBtn = () =&gt; &#123;</span><br><span class="line">  store.commit(&#x27;setCount&#x27;, ++count.value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const count = ref(0)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;h1&gt;&#123;&#123; showCount &#125;&#125;&lt;/h1&gt;</span><br><span class="line">  &lt;button type=&quot;button&quot; @click=&quot;addBtn&quot;&gt;新增&lt;/button&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<h2 id="导入Element-Plus第三方组件库"><a href="#导入Element-Plus第三方组件库" class="headerlink" title="导入Element Plus第三方组件库"></a>导入Element Plus第三方组件库</h2><p>进入Element UI Plus官网，按照要求将其导入到项目中。</p>
<h2 id="页面总布局"><a href="#页面总布局" class="headerlink" title="页面总布局"></a>页面总布局</h2><p>在正式开始编写代码之前，首先点出一个setup语法糖：</p>
<p><code>&lt;script setup lang=&#39;ts&#39;&gt;</code></p>
<p>此处script标签中标记了setup，也就是</p>
<ul>
<li>不需要再return模板中所需要的数据项（数据、方法）了</li>
<li>引入的组件可以直接使用，无需再通过components进行注册了</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;script lang=&#x27;ts&#x27;&gt;</span><br><span class="line">const n: number = ref(0)</span><br><span class="line">let name: string = ref(&#x27;张九龄&#x27;)</span><br><span class="line">const sayHello = () =&gt; &#123;</span><br><span class="line">    console.log(&#x27;Hello Vue!&#x27;)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">// 需要将模板中用到的数据项暴露出来（return）</span><br><span class="line">return &#123;</span><br><span class="line">    n,</span><br><span class="line">    name,</span><br><span class="line">    ...,</span><br><span class="line">    sayHello,</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&#x27;ts&#x27;&gt;</span><br><span class="line">// 这个script标签中的写法和上面的等价</span><br><span class="line">const n: number = ref(0)</span><br><span class="line">let name: string = ref(&#x27;张九龄&#x27;)</span><br><span class="line">const sayHello = () =&gt; &#123;</span><br><span class="line">    console.log(&#x27;Hello Vue!&#x27;)</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>我们新建立一个layout文件夹，用于存放布局组件，在其下建立Index.vue文件，选好的布局包括头部、主体、边栏三部分，在ElementPlus官网将相关的代码段直接复用过来：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- layou --&gt;</span><br><span class="line">&lt;el-container&gt;</span><br><span class="line">  &lt;el-aside width=&quot;200px&quot;&gt;Aside&lt;/el-aside&gt;</span><br><span class="line">  &lt;el-container&gt;</span><br><span class="line">    &lt;el-header&gt;Header&lt;/el-header&gt;</span><br><span class="line">    &lt;el-main&gt;Main&lt;/el-main&gt;</span><br><span class="line">  &lt;/el-container&gt;</span><br><span class="line">&lt;/el-container&gt;</span><br></pre></td></tr></table></figure>



<h2 id="头部栏、导航栏的抽离"><a href="#头部栏、导航栏的抽离" class="headerlink" title="头部栏、导航栏的抽离"></a>头部栏、导航栏的抽离</h2><p>我们对已有的layout文件夹进行重构。目前该目录下仅有Index.vue文件，我们再新建一个header和一个menu文件夹，其中分别新建Header.vue和MenuBar.vue文件，用于分离该页面布局。</p>
<p>以MenuBar.vue文件为例，我们实现左侧的导航栏：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-menu</span><br><span class="line">    active-text-color=&quot;#ffd04b&quot;</span><br><span class="line">    background-color=&quot;#545c64&quot;</span><br><span class="line">    class=&quot;el-menu-vertical-demo&quot;</span><br><span class="line">    default-active=&quot;2&quot;</span><br><span class="line">    text-color=&quot;#fff&quot;</span><br><span class="line">    @open=&quot;handleOpen&quot;</span><br><span class="line">    @close=&quot;handleClose&quot;</span><br><span class="line">  &gt;</span><br><span class="line">    &lt;el-sub-menu index=&quot;1&quot;&gt;</span><br><span class="line">      &lt;template #title&gt;</span><br><span class="line">        &lt;el-icon&gt;&lt;location /&gt;&lt;/el-icon&gt;</span><br><span class="line">        &lt;span&gt;Navigator One&lt;/span&gt;</span><br><span class="line">      &lt;/template&gt;</span><br><span class="line">      &lt;el-menu-item-group title=&quot;Group One&quot;&gt;</span><br><span class="line">        &lt;el-menu-item index=&quot;1-1&quot;&gt;item one&lt;/el-menu-item&gt;</span><br><span class="line">        &lt;el-menu-item index=&quot;1-2&quot;&gt;item one&lt;/el-menu-item&gt;</span><br><span class="line">      &lt;/el-menu-item-group&gt;</span><br><span class="line">      &lt;el-menu-item-group title=&quot;Group Two&quot;&gt;</span><br><span class="line">        &lt;el-menu-item index=&quot;1-3&quot;&gt;item three&lt;/el-menu-item&gt;</span><br><span class="line">      &lt;/el-menu-item-group&gt;</span><br><span class="line">      &lt;el-sub-menu index=&quot;1-4&quot;&gt;</span><br><span class="line">        &lt;template #title&gt;item four&lt;/template&gt;</span><br><span class="line">        &lt;el-menu-item index=&quot;1-4-1&quot;&gt;item one&lt;/el-menu-item&gt;</span><br><span class="line">      &lt;/el-sub-menu&gt;</span><br><span class="line">    &lt;/el-sub-menu&gt;</span><br><span class="line">    &lt;el-menu-item index=&quot;2&quot;&gt;</span><br><span class="line">      &lt;el-icon&gt;&lt;icon-menu /&gt;&lt;/el-icon&gt;</span><br><span class="line">      &lt;span&gt;Navigator Two&lt;/span&gt;</span><br><span class="line">    &lt;/el-menu-item&gt;</span><br><span class="line">    &lt;el-menu-item index=&quot;3&quot; disabled&gt;</span><br><span class="line">      &lt;el-icon&gt;&lt;document /&gt;&lt;/el-icon&gt;</span><br><span class="line">      &lt;span&gt;Navigator Three&lt;/span&gt;</span><br><span class="line">    &lt;/el-menu-item&gt;</span><br><span class="line">    &lt;el-menu-item index=&quot;4&quot;&gt;</span><br><span class="line">      &lt;el-icon&gt;&lt;setting /&gt;&lt;/el-icon&gt;</span><br><span class="line">      &lt;span&gt;Navigator Four&lt;/span&gt;</span><br><span class="line">    &lt;/el-menu-item&gt;</span><br><span class="line">  &lt;/el-menu&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script setup lang=&quot;ts&quot;&gt;</span><br><span class="line">import &#123;</span><br><span class="line">  Location,</span><br><span class="line">  Document,</span><br><span class="line">  Menu as IconMenu,</span><br><span class="line">  Setting,</span><br><span class="line">&#125; from &#x27;@element-plus/icons-vue&#x27;</span><br><span class="line">const handleOpen = (key: string, keyPath: string[]) =&gt; &#123;</span><br><span class="line">  console.log(key, keyPath)</span><br><span class="line">&#125;</span><br><span class="line">const handleClose = (key: string, keyPath: string[]) =&gt; &#123;</span><br><span class="line">  console.log(key, keyPath)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;style&gt;&lt;/style&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://luqingbys.github.io/mid-lake-pavilion.github.io/2022/03/01/Vue3-TypeScript%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98%E8%87%AA%E7%BB%83/" data-id="cl17apw22001cicudhr1x6tno" data-title="Vue3+TypeScript项目实战自练" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Vue源码阅读之虚拟VNode节点" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/mid-lake-pavilion.github.io/2022/02/14/Vue%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8B%E8%99%9A%E6%8B%9FVNode%E8%8A%82%E7%82%B9/" class="article-date">
  <time class="dt-published" datetime="2022-02-14T05:26:51.000Z" itemprop="datePublished">2022-02-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/mid-lake-pavilion.github.io/2022/02/14/Vue%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8B%E8%99%9A%E6%8B%9FVNode%E8%8A%82%E7%82%B9/">Vue源码阅读之虚拟VNode节点</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="JavaScript的正则表达式"><a href="#JavaScript的正则表达式" class="headerlink" title="JavaScript的正则表达式"></a>JavaScript的正则表达式</h2><h3 id="元字符"><a href="#元字符" class="headerlink" title="元字符"></a>元字符</h3><p>与Python中的元字符类似，JavaScript也有元字符，它们是正则表达式中最基础的部分，理解、掌握了它们，就相当于掌握了正则表达式的一半。</p>
<h3 id="重要匹配方法"><a href="#重要匹配方法" class="headerlink" title="重要匹配方法"></a>重要匹配方法</h3><h4 id="exec"><a href="#exec" class="headerlink" title="exec()"></a>exec()</h4><p>在设置了 global 或 sticky 标志位的情况下（如 &#x2F;foo&#x2F;g or &#x2F;foo&#x2F;y），JavaScript RegExp 对象是有状态的。他们会将上次成功匹配后的位置记录在 lastIndex 属性中。使用此特性，exec() 可用来对单个字符串中的多次匹配结果进行逐条的遍历（包括捕获到的匹配）。</p>
<p>正则表达式的lastIndex属性：记录了匹配成功的第一个元素下标。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;../vue/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">            &#123;&#123; title &#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123;&#123; author &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> vm = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">el</span>: <span class="string">&#x27;#main&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">data</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">title</span>: <span class="string">&#x27;三国演义&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">                <span class="attr">author</span>: <span class="string">&#x27;罗贯中&#x27;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> defaultTagRE = <span class="regexp">/\&#123;\&#123;((?:.|\n)+?)\&#125;\&#125;/g</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> text = <span class="string">`&lt;div id=&quot;main&quot;&gt;&lt;p&gt;&#123;&#123; title &#125;&#125;&lt;/p&gt;&lt;span&gt;&#123;&#123; author &#125;&#125;&lt;/span&gt;&lt;/div&gt;`</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">while</span> (match = defaultTagRE.<span class="title function_">exec</span>(text)) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(defaultTagRE.<span class="property">lastIndex</span>);</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(match); <span class="comment">// 匹配结果，是一个特殊的数组</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">console</span>.<span class="title function_">log</span>(match[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>使用while循环语句以及exec()，可以匹配出全部满足条件的字符串；</li>
<li>defaultTagRE是正则表达式，它被设置为全局，具有状态，可以利用它的lastIndex属性，获取上一次匹配成功时的起始字符下标，比如这里第一个匹配成功的是“Vue源码阅读之虚拟VNode节点”，从原字符串text的第19个字符开始，故第一轮循环的打印结果就是19。</li>
</ul>
<p>上述代码的控制台输出结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">29</span></span><br><span class="line">(<span class="number">2</span>) <span class="punctuation">[</span>&#x27;<span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> title <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>&#x27;<span class="punctuation">,</span> &#x27; title &#x27;<span class="punctuation">,</span> index<span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span> input<span class="punctuation">:</span> &#x27;&lt;div id=<span class="string">&quot;main&quot;</span>&gt;&lt;p&gt;<span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> title <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>&lt;/p&gt;&lt;span&gt;<span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> author <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>&lt;/span&gt;&lt;/div&gt;&#x27;<span class="punctuation">,</span> groups<span class="punctuation">:</span> undefined<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> title <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="number">51</span></span><br><span class="line">(<span class="number">2</span>) <span class="punctuation">[</span>&#x27;<span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> author <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>&#x27;<span class="punctuation">,</span> &#x27; author &#x27;<span class="punctuation">,</span> index<span class="punctuation">:</span> <span class="number">39</span><span class="punctuation">,</span> input<span class="punctuation">:</span> &#x27;&lt;div id=<span class="string">&quot;main&quot;</span>&gt;&lt;p&gt;<span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> title <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>&lt;/p&gt;&lt;span&gt;<span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> author <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span>&lt;/span&gt;&lt;/div&gt;&#x27;<span class="punctuation">,</span> groups<span class="punctuation">:</span> undefined<span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#123;</span> author <span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="AST语法树"><a href="#AST语法树" class="headerlink" title="AST语法树"></a>AST语法树</h2><p>AST树，即abstract syntax tree树，意为抽象语法树。经过generage过程，得到render函数，将返回Vue的虚拟DOM节点（包含标签名、子节点、文本信息等）。<br>比如下面这一句html语言，定义了一个input标签，是一个html表单元素：<br><code>&lt;input class=&quot;warn&quot; value=&quot;default text&quot; :style=&quot;innerStyle&quot;&gt;</code><br>解析后的AST节点：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">inputAstElm = <span class="punctuation">&#123;</span></span><br><span class="line">  type<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  tag<span class="punctuation">:</span> &#x27;input&#x27;<span class="punctuation">,</span></span><br><span class="line">  attrs<span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> name<span class="punctuation">:</span> <span class="string">&quot;class&quot;</span><span class="punctuation">,</span> value<span class="punctuation">:</span> <span class="string">&quot;\&quot;warn\&quot;&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span> name<span class="punctuation">:</span> <span class="string">&quot;style&quot;</span><span class="punctuation">,</span> value<span class="punctuation">:</span> <span class="string">&quot;innerStyle&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  props<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">&#123;</span> name<span class="punctuation">:</span> <span class="string">&quot;value&quot;</span><span class="punctuation">,</span> value<span class="punctuation">:</span> <span class="string">&quot;\&quot;default text\&quot;&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="从手写函数开始建立节点"><a href="#从手写函数开始建立节点" class="headerlink" title="从手写函数开始建立节点"></a>从手写函数开始建立节点</h2><p>我们希望通过调用这样的函数就可以创建一棵虚拟节点树（VNode）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ul =</span><br><span class="line">    <span class="title function_">c</span>(<span class="string">&#x27;ul&#x27;</span>, [</span><br><span class="line">      <span class="title function_">c</span>(<span class="string">&#x27;li&#x27;</span>, [ <span class="title function_">t</span>(<span class="string">&quot;Item 1&quot;</span>) ]),</span><br><span class="line">      <span class="title function_">c</span>(<span class="string">&#x27;li&#x27;</span>, [ <span class="title function_">t</span>(<span class="string">&quot;Item 2&quot;</span>) ]),</span><br><span class="line">      <span class="title function_">c</span>(<span class="string">&#x27;li&#x27;</span>, [ <span class="title function_">t</span>(<span class="string">&quot;Item 3&quot;</span>) ])</span><br><span class="line">    ])</span><br></pre></td></tr></table></figure>

<p>这其中需要用到JavaScript的正则表达式提取相关内容。细节参见源码注释。</p>
<p>在建立虚拟节点VNode之后，我们就可以通过VNode来间接管理DOM了——要做到这一点，我们还需要在两者之间建立关联：</p>
<ul>
<li><p>将当前建立的VNode渲染到DOM树上；</p>
</li>
<li><p>当VNode有更新时，DOM树也要相应地作出变化。</p>
<p>这其中涉及到了Vue中的<strong>diff算法</strong>。源码中由patch()函数总体控制对新旧VNode的更改：<code>patch(oldVnode, newVnode)</code>。</p>
<p>而要实现新旧VNode节点的更新，首先要做的是判断两者标签是否一致：如果两者连标签都不一样了，那么就需要相对较为复杂的操作——</p>
<ul>
<li>找到oldVnode对应的DOM节点以及父节点；</li>
<li>将当前newVnode渲染到原来的父节点下；</li>
<li>将旧的DOM节点移除。</li>
</ul>
<p>如果两者标签一致，那么就需要比较它们的子节点（children）了。为此，我们设置四个指针oldStartVnode、oldEndVnode、newStartVnode、oldEndVnode，用于指向oldVnode和newVnode的子节点开始、结束的位置。</p>
<p>然后就是四种情况了。</p>
</li>
</ul>
<h2 id="Compile编译字符串"><a href="#Compile编译字符串" class="headerlink" title="Compile编译字符串"></a>Compile编译字符串</h2><h3 id="从字符串到HTMLElement-Token流"><a href="#从字符串到HTMLElement-Token流" class="headerlink" title="从字符串到HTMLElement Token流"></a>从字符串到HTMLElement Token流</h3><p>但是相对于上面的手动调用函数，我们更希望一个函数能够解析html字符串，就比如这里的compile：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> html =</span><br><span class="line">    <span class="string">`&lt;ul&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;Item 1&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;Item 2&lt;/li&gt;</span></span><br><span class="line"><span class="string">      &lt;li&gt;Item 3&lt;/li&gt;</span></span><br><span class="line"><span class="string">    &lt;/ul&gt;`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ul = <span class="title function_">compile</span>(html)</span><br></pre></td></tr></table></figure>

<p>我们以Token流的形式记录每一个html标签转换后的内容，它是一个列表：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">Attr</span> &#123;</span><br><span class="line">	<span class="attr">name</span>: <span class="built_in">string</span>,</span><br><span class="line">	<span class="attr">value</span>: <span class="built_in">any</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">StartToken</span> &#123;</span><br><span class="line">	<span class="attr">tagName</span>: <span class="built_in">string</span>,</span><br><span class="line">	<span class="attr">attrs</span>: <span class="title class_">Attr</span>[],</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Token流形状</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Tokens</span> &#123;</span><br><span class="line">	<span class="attr">startToken</span>: <span class="title class_">StartToken</span>,</span><br><span class="line">	<span class="attr">charsToken</span>: <span class="built_in">string</span>,</span><br><span class="line">	<span class="attr">endToken</span>: <span class="built_in">any</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 也即：</span></span><br><span class="line"><span class="attr">tokens</span>: = [</span><br><span class="line">	<span class="title class_">StartToken</span>: &#123;</span><br><span class="line">		<span class="attr">tagName</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">		<span class="attr">attrs</span>: [</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="attr">name</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">				<span class="attr">value</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">			&#125;,</span><br><span class="line">			...</span><br><span class="line">		]</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="title class_">StartToken</span>: &#123;&#125;,</span><br><span class="line">	...,</span><br><span class="line">	<span class="title class_">CharsToken</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">	...,</span><br><span class="line">	endToken,</span><br><span class="line">	...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>StartToken表示开始标签<br>EndToken表示结束标签<br>CharsToken表示文本节点</p>
<p>其中的解析过程就是一个类似括号匹配问题的栈的实际应用：</p>
<p>设置一个栈，用于管理字符串，当标签匹配的时候就把栈顶元素弹出，否则入栈；同时将解析出来的标签转化为Token计入Tokens流。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/raphealguo/how-to-learn-vue2-blob/raw/master/figure/1.2/str2tokens.png">https://github.com/raphealguo/how-to-learn-vue2-blob/raw/master/figure/1.2/str2tokens.png</a></p>
<h3 id="从HTMLElement-Token流到AST树"><a href="#从HTMLElement-Token流到AST树" class="headerlink" title="从HTMLElement Token流到AST树"></a>从HTMLElement Token流到AST树</h3><p>拿到tokens序列后，我们可以构建AST树节点。AST树节点形状大致如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tagAstElement = &#123;</span><br><span class="line">	<span class="attr">type</span>: <span class="built_in">number</span>,</span><br><span class="line">	<span class="attr">tag</span>: <span class="built_in">string</span>,</span><br><span class="line">	attrsList,</span><br><span class="line">	attrsMap,</span><br><span class="line">	children,</span><br><span class="line">	parent,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们构建一棵AST树，也需要一个栈stack，记录所有的父节点，同时定义一个指向栈顶的指针currentParent：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> stack = []</span><br><span class="line"><span class="keyword">let</span> currentParent</span><br></pre></td></tr></table></figure>

<p>在源码中，处理Tokens流，得到AST树的函数parse()中，在其中的parseHTML()参数中定义了三个函数：</p>
<ul>
<li>start，处理开始标签流</li>
<li>end，处理结束标签流</li>
<li>chars，处理文本标签流</li>
</ul>
<p>在处理开始标签流时，需要将上面的Tokens中的数据项往AST树的数据项转化。另外，由于AST树包含了节点之间的父子关系，因此在处理开始标签流时，需要判断它是否是单标签，如果不是单标签，就表示该标签之间还可以嵌套其他的标签，该标签也可以作为父节点；因此，该标签需要入栈stack，并且currentParent指针指向栈顶元素——该标签：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!unary) &#123; </span><br><span class="line">    <span class="comment">// 如果不是单标签，则当前节点记为父节点，并压入堆栈</span></span><br><span class="line">    currentParent = element</span><br><span class="line">    stack.<span class="title function_">push</span>(element)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在处理结束标签流时，同样的道理，需要弹栈：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标签闭合，栈顶元素弹出，长度减一，当前父节点指针currentParent指向最新的栈顶元素</span></span><br><span class="line">stack.<span class="property">length</span> -= <span class="number">1</span></span><br><span class="line">currentParent = stack[stack.<span class="property">length</span> - <span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<h3 id="从AST树到VNode树"><a href="#从AST树到VNode树" class="headerlink" title="从AST树到VNode树"></a>从AST树到VNode树</h3><p>将已经生成的AST节点转化为VNode的方法如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_c (tag, data, children) 创建一个非文本 <span class="title class_">VNode</span> 节点</span><br><span class="line">_v (text) 创建一个文本<span class="title class_">VNode</span>节点</span><br><span class="line">_s (exp) 把 exp 输出成字符串</span><br><span class="line"><span class="title function_">_e</span>() 创建一个空的 <span class="title class_">VNode</span></span><br><span class="line">_l (list, render) 渲染一个 <span class="title class_">VNode</span> 列表</span><br><span class="line"><span class="title function_">_k</span>(eventKeyCode, key, builtInAlias) 判定当前事件的按键是否为预期按键值，builtInAlias == eventKeyCode</span><br></pre></td></tr></table></figure>

<p>VNode节点形状如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">VNode</span> = &#123;</span><br><span class="line">	<span class="attr">tag</span>: <span class="string">&#x27;xxx&#x27;</span>,	<span class="comment">// 标签名</span></span><br><span class="line">	<span class="attr">data</span>: &#123;</span><br><span class="line">		<span class="attr">attrs</span>: &#123;...&#125;,	<span class="comment">// 标签的属性</span></span><br><span class="line">        <span class="attr">domProps</span>: &#123; <span class="string">&quot;value&quot;</span>: <span class="string">&quot;default text&quot;</span> &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在实际的源码中，实现了逐步封装（见&#x2F;compiler&#x2F;codegen&#x2F;index.js文件）</p>
<ul>
<li><p><code>generate: (ast: any) =&gt; obj</code>，这个函数是最外层的函数，接收传入的ast树，并将其挂载到当前的vm实例对象，用于生成一棵VNode树。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">generate</span>(<span class="params">ast</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> code = ast ? <span class="title function_">genElement</span>(ast) : <span class="string">&#x27;_c(&quot;div&quot;)&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="attr">render</span>: (<span class="string">&quot;with(this)&#123;return &quot;</span> + code + <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>genElement: (el: any) =&gt; string</code>，接下来把目光转移到第二层函数，它用于生成具体执行的代码语句（字符串格式）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genElement</span>(<span class="params">el</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">for</span> &amp;&amp; !el.<span class="property">forProcessed</span>) &#123; <span class="comment">// 为了v-for和v-if的优先级： &lt;ul v-for=&quot;(item, index) in list&quot; v-if=&quot;index==0&quot;&gt;，需要先处理for语句</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genFor</span>(el)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">if</span> &amp;&amp; !el.<span class="property">ifProcessed</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">genIf</span>(el)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> code</span><br><span class="line">    <span class="keyword">const</span> children = <span class="title function_">genChildren</span>(el) || <span class="string">&#x27;[]&#x27;</span></span><br><span class="line">    <span class="keyword">const</span> data = <span class="title function_">genData</span>(el)</span><br><span class="line"></span><br><span class="line">    code = <span class="string">`_c(&#x27;<span class="subst">$&#123;el.tag&#125;</span>&#x27;<span class="subst">$&#123;</span></span></span><br><span class="line"><span class="subst"><span class="string">      children ? <span class="string">`,<span class="subst">$&#123;children&#125;</span>`</span> : <span class="string">&#x27;&#x27;</span> // children</span></span></span><br><span class="line"><span class="subst"><span class="string">    &#125;</span>)`</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不难发现，这一层函数其实也没做多少事，关键还得看genFor、genIf、genChildren、genData这几个打工人（它们生成了模板字符串中的模板变量，也就是el上缺省的属性值el.tag, el.children, el.data）。</p>
</li>
<li><p><code>genData: (el: any) =&gt; string</code>, 我们先来看看分量最重的data子选项。genData用于得到data，而data包含了el的很多属性，如el.key, el.attrs, el.props, el.event等，其中，el.attrs、el.props、el.events相对较复杂，因此又套了一层函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genData</span>(<span class="params">el</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">&#x27;&#123;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// key</span></span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">key</span>) &#123;</span><br><span class="line">    data += <span class="string">`key:<span class="subst">$&#123;el.key&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">attrs</span>) &#123;</span><br><span class="line">    data += <span class="string">`attrs:&#123;<span class="subst">$&#123;genProps(el.attrs)&#125;</span>&#125;,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// DOM props</span></span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">props</span>) &#123;</span><br><span class="line">    data += <span class="string">`domProps:&#123;<span class="subst">$&#123;genProps(el.props)&#125;</span>&#125;,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// event handlers</span></span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">events</span>) &#123;</span><br><span class="line">    data += <span class="string">`<span class="subst">$&#123;genHandlers(el.events)&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// class</span></span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">staticClass</span>) &#123;</span><br><span class="line">    data += <span class="string">`staticClass:<span class="subst">$&#123;el.staticClass&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (el.<span class="property">classBinding</span>) &#123;</span><br><span class="line">    data += <span class="string">`class:<span class="subst">$&#123;el.classBinding&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  data = data.<span class="title function_">replace</span>(<span class="regexp">/,$/</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>genProps: (props: []) =&gt; string</code>, 这个函数用于将props配置项数组的每一项转为字符串键值对，然后全部拼接起来，并返回。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">genProps</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; props.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> prop = props[i]</span><br><span class="line">    res += <span class="string">`&quot;<span class="subst">$&#123;prop.name&#125;</span>&quot;:<span class="subst">$&#123;prop.value&#125;</span>,`</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>) <span class="comment">// 去掉尾巴的逗号</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>_c()方法可以生成一个VNode，从而实现AST到VNode的过程。</p>
<h2 id="用一个栗子做个总结"><a href="#用一个栗子做个总结" class="headerlink" title="用一个栗子做个总结"></a>用一个栗子做个总结</h2><ol>
<li><p>原始字符串如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">&quot;warn&quot;</span> <span class="attr">value</span>=<span class="string">&quot;default text&quot;</span> <span class="attr">:style</span>=<span class="string">&quot;innerStyle&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>对原始字符串进行解析，得到Token流</p>
</li>
<li><p>将Tokens流转为AST：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">inputAstElm = &#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="number">1</span>,	<span class="comment">// 表示类型</span></span><br><span class="line">    <span class="attr">tag</span>: <span class="string">&#x27;input&#x27;</span>,	<span class="comment">// 表示html元素标签</span></span><br><span class="line">    <span class="attr">attrs</span>: [	<span class="comment">// 表示属性</span></span><br><span class="line">        &#123;<span class="attr">name</span>: <span class="string">&#x27;class&#x27;</span>, <span class="attr">value</span>: <span class="string">&quot;&#x27;warn&#x27;&quot;</span>&#125;,</span><br><span class="line">        &#123;<span class="attr">name</span>: <span class="string">&#x27;style&#x27;</span>, <span class="attr">value</span>: <span class="string">&quot;innerStyle&quot;</span>&#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">props</span>: [&#123; <span class="attr">name</span>: <span class="string">&quot;value&quot;</span>, <span class="attr">value</span>: <span class="string">&quot;&#x27;default text&#x27;&quot;</span> &#125;],	<span class="comment">// 表示属性</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>经过上面提过的render函数得到VNode：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_c</span>(<span class="string">&quot;input&quot;</span>, &#123;</span><br><span class="line">    <span class="attr">attrs</span>: &#123; <span class="string">&quot;class&quot;</span>: <span class="string">&quot;warn&quot;</span>, <span class="string">&quot;style&quot;</span>: innerStyle &#125;,</span><br><span class="line">    <span class="attr">domProps</span>: &#123; <span class="string">&quot;value&quot;</span>: <span class="string">&quot;default text&quot;</span> &#125;</span><br><span class="line">&#125;, [])</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">VNode</span> = &#123;</span><br><span class="line">    <span class="attr">tag</span>: <span class="string">&#x27;input&#x27;</span>,</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">        <span class="attr">attrs</span>: &#123; <span class="string">&quot;class&quot;</span>: <span class="string">&quot;warn&quot;</span>, <span class="string">&quot;style&quot;</span>: <span class="string">&quot;vm.innerStyle运行后的值&quot;</span> &#125;,</span><br><span class="line">        <span class="attr">domProps</span>: &#123; <span class="string">&quot;value&quot;</span>: <span class="string">&quot;default text&quot;</span> &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后一步，将虚拟VNode渲染到真是DOM</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inputDom.<span class="title function_">setAttribute</span>(<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;warn&#x27;</span>)</span><br><span class="line">inputDom.<span class="title function_">setAttribute</span>(<span class="string">&#x27;style&#x27;</span>, <span class="string">&#x27;vm.innerStyle运行后的值&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p>“They are here because of you.”<br>“…What if everyone forgot who I was? They are coming here because of me, right? Becase I’m Peter Parker? But this time, make everyone forget who Peter Parker is. Make every one forget …me.”<br>“But you got to understand, that would mean everyone, who knows and loves you…We…we’d have no memory of you. It will be as though you never existed.”</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://luqingbys.github.io/mid-lake-pavilion.github.io/2022/02/14/Vue%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8B%E8%99%9A%E6%8B%9FVNode%E8%8A%82%E7%82%B9/" data-id="cl17apw24001iicudb7nm1b2g" data-title="Vue源码阅读之虚拟VNode节点" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Vue源码阅读之数据响应式" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/mid-lake-pavilion.github.io/2022/02/12/Vue%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E5%BC%8F/" class="article-date">
  <time class="dt-published" datetime="2022-02-12T06:23:03.000Z" itemprop="datePublished">2022-02-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/mid-lake-pavilion.github.io/2022/02/12/Vue%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E5%BC%8F/">Vue源码阅读之数据响应式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>在Vue源码中，数据的响应式原理是一个重点。此外，vue使用了观察者模式，在源码中体现为</p>
<ul>
<li>Observer：发布者</li>
<li>Dep：依赖，联系发布者与订阅者的纽带</li>
<li>Watcher：订阅者</li>
</ul>
<p>其中，Observer是发布者，用于监视数据的读写对应的index.js文件中，实现了数据劫持。而数据劫持的关键，在于使用ES5的Object.defineProperty()重写属性的getter&#x2F;setter:</p>
<ol>
<li>getter中实现依赖收集<br>所谓依赖，就是vue会在组件渲染的过程中把“接触”（也就是读取数据，触发其get函数）过的数据属性记录为依赖（此为依赖收集），方便后续组件的更新。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="attr">get</span>: <span class="keyword">function</span> <span class="title function_">reactiveGetter</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.<span class="title function_">call</span>(obj) : val</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">        <span class="comment">// getA发生的时候，Dep.target == DepM</span></span><br><span class="line">        dep.<span class="title function_">depend</span>() <span class="comment">// 这一句为关键</span></span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          childOb.<span class="property">dep</span>.<span class="title function_">depend</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(value)) &#123;</span><br><span class="line">          <span class="title function_">dependArray</span>(value)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> val</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line"><span class="comment">// dep.js</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Dep类中函数depend，调用Dep.target中存放的Watcher实例的addDep方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  depend () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title class_">Dep</span>.<span class="property">target</span>) &#123;</span><br><span class="line">      <span class="title class_">Dep</span>.<span class="property">target</span>.<span class="title function_">addDep</span>(<span class="variable language_">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// watcher.js</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 添加依赖，即订阅Dep，同时让Dep知道该Watcher订阅着它</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> &#123;<span class="type">Dep</span>&#125; dep </span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  addDep (dep) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = dep.<span class="property">id</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">newDepIds</span>.<span class="title function_">add</span>(id)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">newDeps</span>.<span class="title function_">push</span>(dep) <span class="comment">// WatcherM.deps.push(DepA) // WatcherM.deps = [DepA, DepB]</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">depIds</span>.<span class="title function_">has</span>(id)) &#123;</span><br><span class="line">        <span class="comment">// 收集订阅者Watcher</span></span><br><span class="line">        dep.<span class="title function_">addSub</span>(<span class="variable language_">this</span>)  <span class="comment">//  DepA.subs.push(WatcherM) // DepA.subs = [WatcherM, WatcherN, WatcherX]</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>setter中实现分发更新<br>当依赖项的setter触发时，会通知watcher，从而使它关联的组件重新渲染（此为分发更新）。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">set</span>: <span class="keyword">function</span> <span class="title function_">reactiveSetter</span>(<span class="params">newVal</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> value = val</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newVal === value) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// console.log(&quot;newVal = &quot;, newVal)</span></span><br><span class="line">  val = newVal</span><br><span class="line"></span><br><span class="line">  childOb = <span class="title function_">observe</span>(newVal)</span><br><span class="line">  <span class="comment">// 通过dep依赖告知更新</span></span><br><span class="line">  dep.<span class="title function_">notify</span>()	<span class="comment">// 这一句为关键</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// vm._update at core/instance/index.js</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// dep.js</span></span><br><span class="line">notify () &#123;</span><br><span class="line">    <span class="comment">// 广播，当劫持到数据变更时，通知订阅者Watcher进行update</span></span><br><span class="line">    <span class="keyword">const</span> subs = <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">slice</span>()</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.<span class="property">length</span>; i &lt; l; i++) &#123;</span><br><span class="line">      subs[i].<span class="title function_">update</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// watcher.js</span></span><br><span class="line">  update () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">lazy</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">dirty</span> = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">run</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  run () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">active</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = <span class="variable language_">this</span>.<span class="title function_">get</span>()</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        value !== <span class="variable language_">this</span>.<span class="property">value</span> ||</span><br><span class="line">        <span class="title function_">isObject</span>(value)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// set new value</span></span><br><span class="line">        <span class="keyword">const</span> oldValue = <span class="variable language_">this</span>.<span class="property">value</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cb</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>.<span class="property">vm</span>, value, oldValue)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如下为Observer&#x2F;index.js中的代码，是Observer类的构造函数的一个代码片段：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">dep</span> = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span><br><span class="line"><span class="comment">// 把当前Observer对象 绑定在value.__ob__上，作为该数据对象已经被Observer观察的标识</span></span><br><span class="line"><span class="comment">// this代指Observer类</span></span><br><span class="line"><span class="title function_">def</span>(value, <span class="string">&#x27;__ob__&#x27;</span>, <span class="variable language_">this</span>)</span><br></pre></td></tr></table></figure>

<p>该Observer实例对象被绑定到了vue实例上，并作为属性‘<strong>ob</strong>‘，我们还可以发现，该Observer实例对象还有成员dep（依赖对象实例），因此我们再到dep.js文件中看看Dep类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span> () &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">id</span> = uid++</span><br><span class="line"><span class="comment">/**subs: Watcher[]，依赖列表，用于收集订阅者Watcher */</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">subs</span> = []</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是Dep类的构造函数，由于依赖项需要通知Watcher更新组件，那么就需要记录与其绑定的Watcher，这里的成员id是该dep的唯一区分标识，而subs用于记录与其相关的订阅者Watcher。</p>
<p>我们自己简单地写一个数据响应式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订阅者Watcher类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Watcher</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 值变化时调用的方法</span></span><br><span class="line">    <span class="title function_">update</span>(<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.name&#125;</span>发生了update.`</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = str</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发布者Dep类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dep</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subs</span> = []</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加Watcher</span></span><br><span class="line">    <span class="title function_">addSub</span>(<span class="params">watcher</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">push</span>(watcher)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 遍历订阅者列表中的所有订阅者</span></span><br><span class="line">    <span class="title function_">notify</span>(<span class="params">str</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">subs</span>.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// item是订阅者Watcher</span></span><br><span class="line">            item.<span class="title function_">update</span>(str)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> w1 = <span class="keyword">new</span> <span class="title class_">Watcher</span>(<span class="string">&#x27;张三&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> w2 = <span class="keyword">new</span> <span class="title class_">Watcher</span>(<span class="string">&#x27;李四&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> w3 = <span class="keyword">new</span> <span class="title class_">Watcher</span>(<span class="string">&#x27;王五&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dep = <span class="keyword">new</span> <span class="title class_">Dep</span>()</span><br><span class="line">dep.<span class="title function_">addSub</span>(w1)</span><br><span class="line">dep.<span class="title function_">addSub</span>(w2)</span><br><span class="line">dep.<span class="title function_">addSub</span>(w3)</span><br><span class="line"></span><br><span class="line">dep.<span class="title function_">notify</span>(<span class="string">&#x27;赵六&#x27;</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>在上面这个简单的栗子中，我们定义了三个订阅者w1, w2, w3，一个发布者dep</li>
<li>对于订阅者，我们订阅（监视）的是name属性</li>
<li>对于发布者Dep，我们可以向其订阅者列表中添加订阅者w1, w2, w3，dep.addSub()</li>
<li>一旦发布者有新内容要发布，就会通知（notify）其订阅者新内容（订阅对象）</li>
<li>上面的通知notify也就是遍历订阅者列表，调用每一个订阅者自身的update()更新方法</li>
</ul>
<p>上面的逻辑初步体现了vue中的数据响应式逻辑，但是还有很多细节，包括Dep何时调用notify()方法，还需要根据源码进一步分析。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://luqingbys.github.io/mid-lake-pavilion.github.io/2022/02/12/Vue%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%93%8D%E5%BA%94%E5%BC%8F/" data-id="cl17apw24001hicudalvnbiyn" data-title="Vue源码阅读之数据响应式" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ES新特性2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/mid-lake-pavilion.github.io/2022/02/11/ES%E6%96%B0%E7%89%B9%E6%80%A72/" class="article-date">
  <time class="dt-published" datetime="2022-02-11T01:54:57.000Z" itemprop="datePublished">2022-02-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/mid-lake-pavilion.github.io/2022/02/11/ES%E6%96%B0%E7%89%B9%E6%80%A72/">ES新特性2</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Promise对象"><a href="#Promise对象" class="headerlink" title="Promise对象"></a>Promise对象</h2><p>Promise的出现，是对异步处理的优化、也是对回调地狱的避免。</p>
<blockquote>
<p>虽然JavaScript本身是单线程的，但是有一些操作可以开启新线程，比如回调函数。换言之，JavaScript一方面从上往下按照语句顺序依次执行，一旦遇上回调函数，就会另外开启一个线程，这个线程中也开始从回调函数最上方往下依次执行，而另一边，并不会等待该回调函数执行完毕，而是直接往下执行JavaScript语句。</p>
</blockquote>
<p>有时候我们需要另外新开启的线程的返回数据，将其作为另一个线程的变量，进行处理，这样一来就需要异步操作，最原始的做法，就是编写回调函数，但是一旦异步操作变多，回调函数嵌套加深，就会带来一个很复杂的链式代码块——回调地狱，其代码逻辑可谓“乱花渐欲迷人眼”，debug起来也是自讨苦吃。</p>
<h3 id="Promise写法简介"><a href="#Promise写法简介" class="headerlink" title="Promise写法简介"></a>Promise写法简介</h3><p>Promise就是一种新写法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="string">&#x27;Lairucy is awesome!&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">p.<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在上面这个简洁的栗子中，Promise()构造函数可以接收一个回调函数作为参数，这个回调函数自身有俩参数，通常记作resolve、reject：</p>
<ul>
<li>resolve函数用于将Promise对象的状态变为“成功”</li>
<li>reject函数用于将Promise对象的状态变为“失败”</li>
</ul>
<h3 id="Promise-then"><a href="#Promise-then" class="headerlink" title="Promise.then()"></a>Promise.then()</h3><p>Promise对象的then()方法是对回调函数的优化，是在Promise对象为成功状态下的进一步处理；换言之，上面的栗子中，再构造函数内部，resolve函数接收了字符串参数，就会将状态变成“成功”，而then()方法就会触发，并且data即为传入的字符串参数。</p>
<h2 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h2><p>proxy，代理，也就是给对象进行一番“修改”，一般用作改变对象原有的属性、逻辑，功能类似于拦截器、预处理。</p>
<p><code>const personProxy = new Proxy(target, handler)</code><br>target是原对象，handler是处理函数，在handler中，我们可以任意修改target对象上的属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> person = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Huxinting&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">999</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> personProxy = <span class="keyword">new</span> <span class="title class_">Proxy</span>(person, &#123;</span><br><span class="line">    <span class="comment">// get(),当原对象被读取时，自动调用</span></span><br><span class="line">    <span class="title function_">get</span>(<span class="params">target, key</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;someone ask for&#x27;</span>, target, key)</span><br><span class="line">        <span class="comment">// 返回读取的结果为属性值大写</span></span><br><span class="line">        <span class="keyword">return</span> target[key].<span class="title function_">toUpperCase</span>()</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// set(), 当原对象被写（修改）时，自动调用</span></span><br><span class="line">    <span class="title function_">set</span>(<span class="params">target, key, value</span>) &#123;</span><br><span class="line">        <span class="comment">// 表示如果要将target对象的key属性的value值修改为一个字符串，就会自动去除其中的空白符</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">typeof</span> value === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">            target[key] = value.<span class="title function_">trim</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line">personProxy.<span class="property">name</span> = <span class="string">&#x27;Luqing     &#x27;</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(personProxy);</span><br><span class="line"><span class="comment">/**&#123; name: &#x27;Luqing&#x27;, age: 999 &#125;</span></span><br><span class="line"><span class="comment"> * Luqing后面的空白符全部去除</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>

<h2 id="再谈JavaScript原型特性"><a href="#再谈JavaScript原型特性" class="headerlink" title="再谈JavaScript原型特性"></a>再谈JavaScript原型特性</h2><p>这并不是ES的新特性，只不过，这个知识点很重要，关联了很多其他的知识和新特性，不得不再次学习。</p>
<blockquote>
<p>为了学好JavaScript的原型，我们首先还是从熟悉的传统OOP讲起。在C++、Java等传统OOP语言中，都是先定义class（类），再根据类创建出实例对象，此时，class中定义的所有属性、方法就会被复制到实例对象中。然而，JavaScript中却并不是这样做的。</p>
</blockquote>
<p>在JavaScript中，对象实例创建时，它会和其创造器之间建立一个链接（也就是对象实例的__proto__属性，派生于构造函数的prototype）<br>也就是说——</p>
<ul>
<li>构造函数的prototype实际上就是对象实例的__proto__对象</li>
<li>构造函数的prototype存储的所有属性、方法，都可以被继承者使用</li>
<li>每一个实例对象都聪原型中继承了constructor属性，该属性指向了用于创建此实例对象的构造函数</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://luqingbys.github.io/mid-lake-pavilion.github.io/2022/02/11/ES%E6%96%B0%E7%89%B9%E6%80%A72/" data-id="cl17apw1d0003icud4q0ddq2w" data-title="ES新特性2" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ES新特性1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/mid-lake-pavilion.github.io/2022/02/10/ES%E6%96%B0%E7%89%B9%E6%80%A71/" class="article-date">
  <time class="dt-published" datetime="2022-02-10T14:23:21.000Z" itemprop="datePublished">2022-02-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/mid-lake-pavilion.github.io/2022/02/10/ES%E6%96%B0%E7%89%B9%E6%80%A71/">ES新特性1</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="字符串模板"><a href="#字符串模板" class="headerlink" title="字符串模板"></a>字符串模板</h2><p>使用反引号的特殊字符串，用法较一般字符串更加方便、功能强大，支持变量替换、换行等等。</p>
<h2 id="解构赋值"><a href="#解构赋值" class="headerlink" title="解构赋值"></a>解构赋值</h2><h3 id="对象的解构赋值"><a href="#对象的解构赋值" class="headerlink" title="对象的解构赋值"></a>对象的解构赋值</h3><blockquote>
<ol>
<li>一般语法格式</li>
<li>let 关键字声明的变量的解构赋值需要提供括号</li>
<li>解构赋值可以嵌套</li>
<li>解构赋值中可以实现变量名的替换</li>
<li>回退机制</li>
</ol>
</blockquote>
<h3 id="数组的解构赋值"><a href="#数组的解构赋值" class="headerlink" title="数组的解构赋值"></a>数组的解构赋值</h3><blockquote>
<ol>
<li>一般语法格式</li>
<li>缺省元素要空出</li>
<li>…others表示剩余全部</li>
<li>数组解构可以方便地用于变量值的交换</li>
</ol>
</blockquote>
<h2 id="四种循环遍历"><a href="#四种循环遍历" class="headerlink" title="四种循环遍历"></a>四种循环遍历</h2><ul>
<li>普通的for循环</li>
<li>数组的forEach</li>
<li>对象的for…in</li>
<li>数组的for…of</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fruits = [<span class="string">&#x27;apple&#x27;</span>, <span class="string">&#x27;mongo&#x27;</span>, <span class="string">&#x27;peach&#x27;</span>, <span class="string">&#x27;banana&#x27;</span>, <span class="string">&#x27;strawberry&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;普通for循环&#x27;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;fruits.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(fruits[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// forEach循环是遍历每一个元素，但是不支持break、continue</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;forEach循环&#x27;</span>);</span><br><span class="line">fruits.<span class="title function_">forEach</span>(<span class="function"><span class="params">fruit</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(fruit);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// for in 循环获取的是数组的属性，并且是遍历数组对象的可枚举属性，通过下标获取可枚举属性值</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;for in循环&#x27;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> index <span class="keyword">in</span> fruits) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(fruits[index]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// for of循环可以获取每一个元素，并且支持break、continue</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;for of循环&#x27;</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> fruit <span class="keyword">of</span> fruits) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(fruit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="for…of循环"><a href="#for…of循环" class="headerlink" title="for…of循环"></a>for…of循环</h3><p>for…of循环在可迭代对象上创建迭代循环，其中可迭代对象包括：<br>Array、String、Map（键值对）、Set（集合）等。</p>
<p>使用<br><code>for ele of obj.entries()</code>,<br>则ele是数组类型（类似map），第一个值为下标，第二个值为元素。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> celes = [<span class="string">&#x27;徐阶&#x27;</span>, <span class="string">&#x27;陆炳&#x27;</span>, <span class="string">&#x27;高拱&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> ele <span class="keyword">of</span> celes) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ele);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">徐阶</span></span><br><span class="line"><span class="comment">陆炳</span></span><br><span class="line"><span class="comment">高拱</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> ele <span class="keyword">of</span> celes.<span class="title function_">entries</span>()) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ele);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[ 0, &#x27;徐阶&#x27; ]</span></span><br><span class="line"><span class="comment">[ 1, &#x27;陆炳&#x27; ]</span></span><br><span class="line"><span class="comment">[ 2, &#x27;高拱&#x27; ]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>在后一种写法中，我们甚至可以使用解构赋值获取元素和其下标：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> [index, person] <span class="keyword">of</span> celes.<span class="title function_">entries</span>()) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(index, person);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="剩余参数"><a href="#剩余参数" class="headerlink" title="剩余参数"></a>剩余参数</h2><p>常用：</p>
<ul>
<li>接收函数参数作为数组</li>
<li>数组的解构赋值</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 此处的...numbers就是剩余参数写法</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sum</span>(<span class="params">...numbers</span>) &#123;</span><br><span class="line">    <span class="comment">// Array.reduce(callback(accumulator, currentValue[, index, array])[, initialValue])</span></span><br><span class="line">    <span class="comment">// accumulator: 累计器，上一次调用callback回调返回的累积值</span></span><br><span class="line">    <span class="comment">// currentValue: 数组中正在处理的元素</span></span><br><span class="line">    <span class="comment">// index: 数组中正在处理的元素的索引</span></span><br><span class="line">    <span class="comment">// array: 正在处理的数组</span></span><br><span class="line">    <span class="comment">// initialValue: 第一次调用callback回调时的第一个参数值，默认为array数组的第一个元素</span></span><br><span class="line">    <span class="keyword">return</span> numbers.<span class="title function_">reduce</span>(<span class="function">(<span class="params">prev, curr</span>) =&gt;</span> prev + curr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">sum</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://luqingbys.github.io/mid-lake-pavilion.github.io/2022/02/10/ES%E6%96%B0%E7%89%B9%E6%80%A71/" data-id="cl17apw1f0005icudali3fz4k" data-title="ES新特性1" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-浏览器" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/mid-lake-pavilion.github.io/2022/02/10/%E6%B5%8F%E8%A7%88%E5%99%A8/" class="article-date">
  <time class="dt-published" datetime="2022-02-10T05:13:11.000Z" itemprop="datePublished">2022-02-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/mid-lake-pavilion.github.io/categories/%E5%89%8D%E7%AB%AF/">前端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/mid-lake-pavilion.github.io/2022/02/10/%E6%B5%8F%E8%A7%88%E5%99%A8/">浏览器</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="宏观视角下的浏览器"><a href="#宏观视角下的浏览器" class="headerlink" title="宏观视角下的浏览器"></a>宏观视角下的浏览器</h2><p>浏览器最开始是美国网景公司开发的，自诞生之日起，地位一直只增不减。</p>
<blockquote>
<p>C&#x2F;S    client、server，即客户端、服务端<br>B&#x2F;S    browser、server，即浏览器、服务端</p>
</blockquote>
<h3 id="浏览器工作原理重要性"><a href="#浏览器工作原理重要性" class="headerlink" title="浏览器工作原理重要性"></a>浏览器工作原理重要性</h3><ol>
<li>了解浏览器如何工作，能够让我们更准确地决策是否可以采用Web来开发项目</li>
<li>站在更高的角度审视前端页面</li>
<li>在技术快速迭代的时代把握本质</li>
</ol>
<h2 id="进程与线程"><a href="#进程与线程" class="headerlink" title="进程与线程"></a>进程与线程</h2><p>进程：就是内存中正在运行的应用程序，包括如下特点：</p>
<ul>
<li>进程在内存中独占一个内存空间</li>
<li>进程与进程之间是隔离的，比如手机玩王者荣耀（进程），如果王者荣耀崩溃了，这个进程就终止了，但是手机中的其他应用（比如微信）不会受到影响（进程之间隔离）</li>
</ul>
<p>线程：进程的最小执行单位。它也有一定的特点：</p>
<ul>
<li>一个进程是由多个线程组成的</li>
<li>每一个线程之间也是相互隔离的（比如微信可以和多个人聊天，也互不干扰）</li>
</ul>
<p>一个页面启动的时候，至少启动了4个进程：</p>
<ul>
<li>浏览器主进程</li>
<li>渲染进程</li>
<li>网络进程</li>
<li>GPU进程</li>
</ul>
<p>如果安装了插件，还会运行插件进程。<br>下面逐个简介这些进程：</p>
<ul>
<li>浏览器主进程：主要负责界面显示、用户交互、子进程管理，同时提供存储等功能；</li>
<li>渲染进程：核心任务是将HTML、CSS和JavaScript转换为用户可以与之交互的网页，排版引擎Blink和JavaScript引擎V8都运行在该进程中；</li>
<li>网络进程：主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，现在已经独立成为单独一个进程；</li>
<li>GPU进程：GPU，即图像处理单元，其使用初衷是为了实现3D、CSS的效果，后来网页等界面都采用了GPU来绘制。</li>
<li>插件进程：主要负责插件运行，由于插件容易崩溃，于是该进程与其他进程隔离开来，防止插件的崩溃影响到浏览器和页面。</li>
</ul>
<h2 id="计算机网络的七层模型"><a href="#计算机网络的七层模型" class="headerlink" title="计算机网络的七层模型"></a>计算机网络的七层模型</h2><p>从下往上的顺序为：</p>
<ol>
<li>物理层：使用一定的物理介质来进行计算机之间的连接，以电信号0、1进行传输；</li>
<li>数据链路层：MAC地址，对物理层的0、1信号进行封装，封装成比特；</li>
<li>网络层：IP地址</li>
<li>传输层：涉及UDP（用户数据包协议）&#x2F;TCP（传输控制协议）</li>
<li>会话层：断点续传</li>
<li>表示层：解决不同系统之间数据传输的问题</li>
<li>应用层：HTTP</li>
</ol>
<blockquote>
<p>UDP：只管发，不管收<br>TCP：具有重传机制、排序机制</p>
</blockquote>
<p>也可以表示为四层：</p>
<ul>
<li>物理层：物理层、数据链路层</li>
<li>网络层</li>
<li>传输层</li>
<li>应用层：会话层、表示层、应用层</li>
</ul>
<h2 id="HTTP请求流程"><a href="#HTTP请求流程" class="headerlink" title="HTTP请求流程"></a>HTTP请求流程</h2><p>浏览器发送HTTP请求的大致请求流程如下：</p>
<ol>
<li>构造请求行</li>
<li>查找缓存</li>
<li>准备IP地址和端口号</li>
<li>等待TCP队列，一个域名最多只能和建立6个TCP连接</li>
<li>建立TCP连接</li>
<li>发送HTTP请求</li>
</ol>
<p>服务器处理HTTP请求的流程：</p>
<ol>
<li>返回请求内容</li>
<li>断开连接</li>
</ol>
<h2 id="从进程角度看浏览器"><a href="#从进程角度看浏览器" class="headerlink" title="从进程角度看浏览器"></a>从进程角度看浏览器</h2><p>从用户在url地址栏到浏览器显示页面，这个过程中到底发生了什么。<br>主要涉及了浏览器主进程、网络进程、渲染进程。</p>
<ol>
<li>用户在浏览器主进程中输入url地址；</li>
<li>浏览器主进程将url请求派发给网络进程；</li>
<li>在网络进程中，发送url请求，获取响应头数据，解析响应头数据；</li>
<li>网络进程将解析出来的数据转发给浏览器主进程；</li>
<li>浏览器主进程接收到网络进程的响应数据，发送“提交文档”（HTML数据）消息给渲染进程；</li>
<li>在渲染进程中，接收到消息之后，准备接收HTML数据，接收数据的方式是直接和网络进程之间建立数据管道。</li>
<li>文档数据传输完毕，渲染进程将会返回“确认提交”消息给浏览器主进程。</li>
<li>在浏览器主进程中，收到渲染进程后“确认提交”消息后，便开始移除旧文档，更新浏览器进程状态。</li>
</ol>
<h2 id="浏览器渲染流程"><a href="#浏览器渲染流程" class="headerlink" title="浏览器渲染流程"></a>浏览器渲染流程</h2><p>以一个很简单的.html文件为例，进行说明：</p>
<ol>
<li>构建DOM树——使用html解析器（ParseHTML）将html页面转化为浏览器能够理解的DOM树；<br>因为浏览器无法直接理解和使用html，因此需要将html转化为浏览器能够理解的结构——DOM树。</li>
<li>将css解析成浏览器能够识别的CSS树</li>
<li>样式计算</li>
<li>由DOM树、CSS树得到布局树</li>
<li>根据布局树生成图层树（只有某些具有特殊属性的节点才会单独占据一个图层）</li>
<li>绘制</li>
<li>组合图层，生成最终的页面<blockquote>
<p>图层：在html页面中，虽然网页是二维的，但是实际上相当于一个“俯视图”，也就是说，实际上是存在“图层”的，以下html元素可以作为一个单独的图层：</p>
<ol>
<li>具有3d效果的元素</li>
<li>fixed固定定位的元素</li>
<li>视频播放元素video</li>
<li>绘图画板canvas</li>
<li>css动画节点</li>
</ol>
</blockquote>
</li>
</ol>
<p>浏览器每次最多可以接收64Kb资源。</p>
<h2 id="图层"><a href="#图层" class="headerlink" title="图层"></a>图层</h2><p>图层是在布局的基础上,为了进一步显示一些复杂的3D变换、页面滚动等效果，也产生的一种渲染结果。</p>
<h3 id="哪些节点会被渲染为新的层"><a href="#哪些节点会被渲染为新的层" class="headerlink" title="哪些节点会被渲染为新的层"></a>哪些节点会被渲染为新的层</h3><p>当然了，并不是布局树的每一个节点都包含一个图层，如果一个节点没有对应的层，那么这个节点就从属于父节点的图层。以下两种情况的节点会被单独提升为一个图层：</p>
<ol>
<li>拥有层叠上下文属性的元素<br>比如，fixed固定定位属性的元素、定义透明属性的元素、使用CSS滤镜的元素等。</li>
<li>需要剪裁（clip）的地方也会被创建为图层。</li>
</ol>
<h3 id="图层绘制"><a href="#图层绘制" class="headerlink" title="图层绘制"></a>图层绘制</h3><h4 id="得到绘制列表"><a href="#得到绘制列表" class="headerlink" title="得到绘制列表"></a>得到绘制列表</h4><p>图层树构建完成后，渲染引擎会对图层树中的每一个图层进行绘制，大体步骤是把每一个图层的绘制拆分成很多个小的绘制指令，然后把这些指令按照顺序组成一个待绘制列表，称为绘制列表。</p>
<blockquote>
<p>在浏览器开发者工具的Layers（图层）选项中，可以清楚地看到，当点击一个图层进行分析，会出现诸如drawRect、drawPaint等小绘制指令。</p>
</blockquote>
<p>当图层的绘制列表准备好之后，主线程会把该绘制列表提交给合成线程，也就是说，接下来的工作将由合成线程完成。</p>
<h4 id="栅格化操作"><a href="#栅格化操作" class="headerlink" title="栅格化操作"></a>栅格化操作</h4><p>合成线程并不会一下子绘制出所有图层内容，因为这样花销太大。它转而会将图层划分为图块（tile，是栅格化执行的最小单位），并且按照视口附近的图块来优先生成位图。<br>所谓栅格化，就是将图块转换为位图，会在线程池内执行，该线程池称为栅格化线程池。</p>
<h4 id="合成、显示"><a href="#合成、显示" class="headerlink" title="合成、显示"></a>合成、显示</h4><p>上述提到的栅格化如果对所有图块都进行完毕，合成线程就会生成一个绘制图块的命令——DrawQuad，然后将该命令提交给浏览器进程，由其中的viz组件接收命令，将页面内容绘制到内存中，最后将内存显示在屏幕上。</p>
<h3 id="重排、重绘、合成"><a href="#重排、重绘、合成" class="headerlink" title="重排、重绘、合成"></a>重排、重绘、合成</h3><p>在厘清这三者之前，我们首先强调浏览器渲染流水线：</p>
<ol>
<li>DOM（生成浏览器可以识别的DOM树）</li>
<li>Style（生成CSS树、样式计算）</li>
<li>Layout（得到布局树）</li>
<li>Layer（得到图层树）</li>
<li>Paint（绘制）</li>
<li>合成操作</li>
</ol>
<p>上述1~5都是需要主线程参与的，而只有最后一步合成不需要主线程参与，需要非主线程（合成线程）参与。</p>
<h4 id="重排"><a href="#重排" class="headerlink" title="重排"></a>重排</h4><p>如果，我们通过JavaScript或者CSS修改元素几何位置属性，比如改变元素宽度、高度等，会引发浏览器重新布局——此之谓“重排”。<br>重排需要更新完整的渲染流水线，所以开销很大。</p>
<h4 id="重绘"><a href="#重绘" class="headerlink" title="重绘"></a>重绘</h4><p>现在情况变了，我们通过JavaScript更改某些元素的背景颜色，很显然，由于几何位置不变，布局不会受到影响，因此渲染流水线中的Layout（布局）阶段不会重新进行，而是直接进入绘制（Paint）阶段，然后再执行其子阶段——此之谓“重绘”。<br>相较于重排，重绘省去了布局和分层阶段，所以执行效率会比重排操作更高一些。</p>
<h4 id="合成（直接合成）"><a href="#合成（直接合成）" class="headerlink" title="合成（直接合成）"></a>合成（直接合成）</h4><p>也即跳过了渲染流水线的布局、绘制，只执行后续合成操作——此之谓“合成”。<br>相比于重排、重绘，合成可以大大提高绘制效率，因为它根本没有占用主线程的资源。</p>
<h2 id="浏览器中JavaScript的执行"><a href="#浏览器中JavaScript的执行" class="headerlink" title="浏览器中JavaScript的执行"></a>浏览器中JavaScript的执行</h2><h3 id="执行上下文"><a href="#执行上下文" class="headerlink" title="执行上下文"></a>执行上下文</h3><h4 id="变量提升"><a href="#变量提升" class="headerlink" title="变量提升"></a>变量提升</h4><p>首先我们需要明白的是，在JavaScript中何为声明，何为赋值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myName = <span class="string">&#x27;奇异博士&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面的语句等价于两句，声明、赋值分离开来写为</span></span><br><span class="line"><span class="keyword">var</span> myName</span><br><span class="line">myName = <span class="string">&#x27;奇异博士&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 以下是一个完整的函数声明</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;foo&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 以下是一个变量声明、赋值，只不过赋值了一个函数</span></span><br><span class="line"><span class="keyword">var</span> hello = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hello!&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么，我们可以得到变量提升的定义：<br>所谓的变量提升，是指在 JavaScript 代码执行过程中，JavaScript 引擎把变量的声明部分和函数的声明部分提升到代码开头的“行为”。变量被提升后，会给变量设置默认值，这个默认值就是我们熟悉的 undefined。</p>
<h4 id="何为执行上下文"><a href="#何为执行上下文" class="headerlink" title="何为执行上下文"></a>何为执行上下文</h4><p>我们从如下一段JavaScript代码分析起：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">showName</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myName)</span><br><span class="line"><span class="keyword">var</span> myName = <span class="string">&#x27;朱由榔&#x27;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showName</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;showName被调用!&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在经过浏览器的JavaScript引擎的编译后，会生成两部分内容：</p>
<ul>
<li>执行上下文（Execution context）</li>
<li>可执行代码</li>
</ul>
<p>所谓执行上下文，是JavaScript执行一段代码时的运行环境，在执行上下文终存在一个变量环境的对象，它保存了变量提升的内容。</p>
<p>以上面的代码为例，逐句分析：</p>
<ul>
<li>第1、2句并不涉及变量声明，JavaScript引擎不作处理；</li>
<li>第3句，JavaScript引擎会在环境对象中创建一个名为myName的属性，并使用undefined对其初始化；</li>
<li>第4句，JavaScript将函数showName定义存储到堆（HEAP）中，并在环境对象中创建了一个showName属性，并用该属性值指向堆中函数的位置。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 执行上下文</span></span><br><span class="line"><span class="keyword">var</span> myName = <span class="literal">undefined</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showName</span>(<span class="params"></span>) &#123;</span><br><span class="line">	<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;showName被调用!&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 可执行代码</span></span><br><span class="line"><span class="title function_">showName</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(myName)</span><br><span class="line">myName = <span class="string">&#x27;朱由榔&#x27;</span></span><br></pre></td></tr></table></figure>

<p>另外，如果变量和函数名相同，那么在编译阶段，变量的声明会被忽略。换言之，函数提升优于变量提升，导致变量声明被忽略。</p>
<h3 id="调用栈"><a href="#调用栈" class="headerlink" title="调用栈"></a>调用栈</h3><p>调用栈，就是用来管理函数调用关系的一种数据结构。<br>通俗地说，每一个函数都对应一个函数上下文，在整个代码片段中，调用栈中保存的都是执行上下文，故又称执行上下文栈。</p>
<p>当然，调用栈也是有大小的，当入栈的执行上下文超过一定数目时，JavaScript引擎就会报错，这种错误就叫栈溢出。</p>
<h3 id="块级作用域"><a href="#块级作用域" class="headerlink" title="块级作用域"></a>块级作用域</h3><h4 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h4><p>在JavaScript中，有两种作用域是ES6之前支持的：</p>
<ul>
<li>全局作用域</li>
<li>函数作用域</li>
</ul>
<p>此外，ES6之前的JavaScript不支持块级作用域（即使用大括号包裹的区域单独形成一个作用域）。</p>
<h4 id="变量提升带来的副作用"><a href="#变量提升带来的副作用" class="headerlink" title="变量提升带来的副作用"></a>变量提升带来的副作用</h4><p>变量提升会带来一些让常人觉得匪夷所思的问题。我们从一个栗子看起。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myname = <span class="string">&quot; 极客时间 &quot;</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">showName</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(myname);</span><br><span class="line">  <span class="keyword">if</span>(<span class="number">0</span>)&#123;</span><br><span class="line">   <span class="keyword">var</span> myname = <span class="string">&quot; 极客邦 &quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(myname);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">showName</span>()</span><br></pre></td></tr></table></figure>

<p>上面代码的运行结果都是undefined。和其他语言（如C）不同，它们都有块级作用域，在此处的打印结果为“ 极客时间 ”。<br>原因就是变量提升以及调用栈。showName函数提升后，会创建执行上下文，即showName的函数执行上下文，它入调用栈，压在全局执行上下文上面。当执行showName函数时，就会在调用栈顶的函数执行上下文中寻找myname变量，它的初始值为undefined，于是打印undefined。</p>
<p>下面的一个栗子也可以说明问题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(i); </span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>()</span><br></pre></td></tr></table></figure>

<p>上述代码的运行结果为7，原因很简单，是因为在创建执行上下文时，变量i会提升，而for循环虽然结束，但是函数并未结束，变量i仍然存在（或者更准确地说，for循环本应该形成一个单独的块级作用域，但是在此处JavaScript并不支持块级作用域）。</p>
<h3 id="ES6的对块级作用域的优化"><a href="#ES6的对块级作用域的优化" class="headerlink" title="ES6的对块级作用域的优化"></a>ES6的对块级作用域的优化</h3><p>JavaScript通过执行上下文来创建作用域（函数执行上下文对应函数作用域、全局执行上下文对应全局作用域），为了进一步说明ES6对作用域的优化，我们进一步分析<strong>执行上下文的组成</strong>：</p>
<ul>
<li>变量环境</li>
<li>词法环境</li>
</ul>
<p>然后，我们给出如下结论：</p>
<ul>
<li>函数内部，通过var声明的变量，在编译阶段全都存放到变量环境中去了</li>
<li>通过let声明的变量，在编译阶段会被存放到词法环境中</li>
<li>在函数的作用域内部，通过let声明的变量并没有被存放到词法环境中</li>
</ul>
<p>其实，在词法环境内部，也维护了一个小型栈结构，栈底是函数最外层的变量，每进入一个作用域块，就会将当前作用域块内部的变量压入栈顶；当作用域执行完毕，该作用域的信息就会从栈顶弹出。这就是词法环境。</p>
<p>最后总结一句话：<strong>JavaScript中的块级作用域就是通过词法环境的栈结构来实现的</strong>。</p>
<p>下面有一个思考题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> myname= <span class="string">&#x27;极客时间&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(myname) </span><br><span class="line">  <span class="keyword">let</span> myname= <span class="string">&#x27;极客邦&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果为：报错。<br>let声明的变量提升，并不是创建、初始化（声明）全部被提升，而是仅仅创建被提升，在初始化之前，会形成一个暂时性死区。</p>
<blockquote>
<p>与通过 var 声明的有初始化值 undefined 的变量不同，通过 let 声明的变量直到它们的定义被执行时才初始化。在变量初始化前访问该变量会导致ReferenceError。该变量处在一个自块顶部到初始化处理的“暂存死区”中。</p>
</blockquote>
<ul>
<li>var的创建和初始化被提升，赋值不会被提升。</li>
<li>let的创建被提升，初始化和赋值不会被提升。</li>
<li>function的创建、初始化和赋值均会被提升。</li>
</ul>
<h2 id="浏览器中的页面循环系统"><a href="#浏览器中的页面循环系统" class="headerlink" title="浏览器中的页面循环系统"></a>浏览器中的页面循环系统</h2><h3 id="消息队列与页面循环"><a href="#消息队列与页面循环" class="headerlink" title="消息队列与页面循环"></a>消息队列与页面循环</h3><p>消息队列是一种数据结构，可以存放要执行的任务，符合队列“先进先出”的特点：在队列尾部添加新任务，在队列头部取出任务。</p>
<p>其实，页面线程所有执行的任务都来自于消息队列，鉴于其“先进先出”的属性，有如下两个问题需要解决：</p>
<ul>
<li>如何处理高优先级的任务——宏任务与微任务</li>
<li>如何解决单个任务执行时间过长的问题——JavaScript的回调功能</li>
</ul>
<h3 id="探究setTimeout"><a href="#探究setTimeout" class="headerlink" title="探究setTimeout"></a>探究setTimeout</h3><p>上面提到过，事件循环系统中存在一个消息队列，并按顺序执行消息队列中的任务，而setTimeout是一个定时器，需要延迟一定时间再执行任务，因此不能直接将要延迟执行的任务放入消息队列中。<br>事实上，在Chrome中除了正常使用的消息队列之外，还有另外一个消息队列，这个队列中维护了需要延迟的任务列表，包括定时器。当定时器被创建时，渲染进程将定时器的回调任务添加到延迟队列中。</p>
<h4 id="定时器的注意事项"><a href="#定时器的注意事项" class="headerlink" title="定时器的注意事项"></a>定时器的注意事项</h4><ol>
<li>如果当前任务执行时间过久，会影响迟到期定时器任务的执行</li>
<li>如果setTimeout存在嵌套调用，那么系统会设置最短时间间隔为4毫秒</li>
<li>未激活的页面，setTimeout执行最小间隔是1000毫秒</li>
<li>延时执行时间有最大值<br>如果setTimeout设置的延迟值大于2147483647毫秒（Chrome以32位来存储延迟值，最大为2^32-1</li>
<li>setTimeout设置的回调函数中的this指向问题<br>如果setTimeout推迟执行的回调函数是某一个对象的方法，那么<strong>该方法中的this指向全局环境window，而不是定义时方法所在的那个对象</strong>。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="number">1</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MyObj</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">showName</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="title class_">MyObj</span>.<span class="property">showName</span>, <span class="number">1000</span>); <span class="comment">// 输出undefined</span></span><br></pre></td></tr></table></figure>

<p>在上面的栗子中，由于showName函数内部的this指向window，而window上并没有name属性，因此呢，控制台输出undefined。<br>对此，一般的解决方法有两种：</p>
<ul>
<li>将showName放到另一个匿名函数中执行（箭头或者ES5写法都行）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="number">1</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MyObj</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">showName</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">MyObj</span>.<span class="title function_">showName</span>()</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="built_in">setTimeout</span>( <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="title class_">MyObj</span>.<span class="title function_">showName</span>()</span><br><span class="line">&#125;, <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>使用bind方法，将showName绑定到MyObj对象上</li>
</ul>
<blockquote>
<p>bind()方法会创建一个新的函数，在bind()被调用时，这个新函数的this会被指定为bind()的第一个参数，而其余参数将作为新函数的参数，供调用时使用。</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="number">1</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">MyObj</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">showName</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 调用MyObj对象的showName方法的bind()，将该函数中的this设置为MyObj</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="title class_">MyObj</span>.<span class="property">showName</span>.<span class="title function_">bind</span>(<span class="title class_">MyObj</span>), <span class="number">1000</span>);</span><br></pre></td></tr></table></figure>

<h3 id="宏任务与微任务"><a href="#宏任务与微任务" class="headerlink" title="宏任务与微任务"></a>宏任务与微任务</h3><ul>
<li>宏任务：页面中大部分任务（渲染事件、用户交互、网络请求完成等）都是在主线程上执行的，这些消息队列中的任务被称为宏任务。</li>
<li>微任务：<br>其实JavaScript在执行一段脚本的时候，V8引擎在创建全局执行上下文的同时创建一个微任务队列，用于存放微任务，这样每一个宏任务都会关联一个微任务队列。</li>
</ul>
<p>当宏任务中的JavaScript快执行完成时，也就在JavaScript引擎准备退出全局执行上下文并清空调用栈的时候，JavaScript引擎会检查全局执行上下文中的微任务队列，然后按照顺序执行队列中的微任务。</p>
<h3 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h3><p>Promise是用来处理异步任务的，以XML网络请求为例，我们先来看看一般的异步操作写法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//makeRequest 用来构造 request 对象</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeRequest</span>(<span class="params">request_url</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> request = &#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;Get&#x27;</span>,</span><br><span class="line">        <span class="attr">url</span>: request_url,</span><br><span class="line">        <span class="attr">headers</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">body</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        <span class="attr">credentials</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">sync</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">responseType</span>: <span class="string">&#x27;text&#x27;</span>,</span><br><span class="line">        <span class="attr">referrer</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> request</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">XFetch</span>(<span class="title function_">makeRequest</span>(<span class="string">&#x27;https://time.geekbang.org/?category&#x27;</span>),</span><br><span class="line">      <span class="keyword">function</span> <span class="title function_">resolve</span>(<span class="params">response</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(response)</span><br><span class="line">          <span class="title class_">XFetch</span>(<span class="title function_">makeRequest</span>(<span class="string">&#x27;https://time.geekbang.org/column&#x27;</span>),</span><br><span class="line">              <span class="keyword">function</span> <span class="title function_">resolve</span>(<span class="params">response</span>) &#123;</span><br><span class="line">                  <span class="variable language_">console</span>.<span class="title function_">log</span>(response)</span><br><span class="line">                  <span class="title class_">XFetch</span>(<span class="title function_">makeRequest</span>(<span class="string">&#x27;https://time.geekbang.org&#x27;</span>)</span><br><span class="line">                      <span class="keyword">function</span> <span class="title function_">resolve</span>(<span class="params">response</span>) &#123;</span><br><span class="line">                          <span class="variable language_">console</span>.<span class="title function_">log</span>(response)</span><br><span class="line">                      &#125;, <span class="keyword">function</span> <span class="title function_">reject</span>(<span class="params">e</span>) &#123;</span><br><span class="line">                          <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">                      &#125;)</span><br><span class="line">              &#125;, <span class="keyword">function</span> <span class="title function_">reject</span>(<span class="params">e</span>) &#123;</span><br><span class="line">                  <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">              &#125;)</span><br><span class="line">      &#125;, <span class="keyword">function</span> <span class="title function_">reject</span>(<span class="params">e</span>) &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(e)</span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure>

<p>上面的代码完成的大概是三次嵌套请求，混乱不堪，难以入目，总结起来问题有两个：</p>
<ul>
<li>嵌套调用，回调函数内部再次执行回调函数</li>
<li>任务具有不确定性，每一个请求任务都有两种可能的结果</li>
</ul>
<p>而Promise就解决了这两个问题。</p>
<p>Promise构造函数语法如下：</p>
<p><code>Promise(function(resolve, reject) &#123;&#125;)</code></p>
<p>其中，resolve是成功的回调函数，reject是失败的回调函数。使用Promise来对上述代码进行优化：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">XFetch</span>(<span class="params">request</span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">executor</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>()</span><br><span class="line">        xhr.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>, request.<span class="property">url</span>, <span class="literal">true</span>)</span><br><span class="line">        xhr.<span class="property">ontimeout</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e)</span><br><span class="line">        &#125;</span><br><span class="line">        xhr.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params">e</span>) &#123;</span><br><span class="line">            <span class="title function_">reject</span>(e)</span><br><span class="line">        &#125;</span><br><span class="line">        xhr.<span class="property">onreadystatechange</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">readyState</span> === <span class="number">4</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">                    <span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">responseText</span>, <span class="variable language_">this</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">let</span> error = &#123;</span><br><span class="line">                        <span class="attr">code</span>: <span class="variable language_">this</span>.<span class="property">status</span>,</span><br><span class="line">                        <span class="attr">response</span>: <span class="variable language_">this</span>.<span class="property">response</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="title function_">reject</span>(error, <span class="variable language_">this</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        xhr.<span class="title function_">send</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(executor)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，调用XFetch()函数会返回一个Promise对象，然后就可以使用Promise.then()方法继续发起请求了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x1 = <span class="title class_">XFetch</span>(<span class="title function_">makeRequest</span>(<span class="string">&#x27;https://time.geekbang.org/?category&#x27;</span>))</span><br><span class="line"><span class="keyword">var</span> x2 = x1.<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">XFetch</span>(<span class="title function_">makeRequest</span>(<span class="string">&#x27;https://www.geekbang.org/column&#x27;</span>))</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> x3 = x2.<span class="title function_">then</span>(<span class="function"><span class="params">value</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(value)</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">XFetch</span>(<span class="title function_">makeRequest</span>(<span class="string">&#x27;https://time.geekbang.org&#x27;</span>))</span><br><span class="line">&#125;)</span><br><span class="line">x3.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h4 id="深入Promise"><a href="#深入Promise" class="headerlink" title="深入Promise"></a>深入Promise</h4><p>Promise用法大致如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> p = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="title function_">resolve</span>()</span><br><span class="line">    ...</span><br><span class="line">    <span class="title function_">reject</span>()</span><br><span class="line">&#125;)</span><br><span class="line">p.<span class="title function_">then</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>按照Promise的语法，resolve()函数的调用会触发p.then()方法，因此，可以推测<strong>resolve函数内部调用了p.then()设置的回调函数</strong>，但是，如果真的是我们所猜测的这样，resolve()执行的时候，p.then()还没有绑定回调函数，这又应当作何解释呢？</p>
<p>答案就是<strong>Promise采用了回调函数延迟绑定技术</strong>，即在执行resolve函数时，由于回调函数还没有绑定到then()上，因此只能推迟回调函数的执行。</p>
<p>下面我们简单自己实现一个支持延时回调的类Promise对象（Bromise）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Bromise</span>(<span class="params">executor</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> onResolve_ = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> onReject_ = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// 给Bromise对象绑定一个then方法，类似于Promise对象的then方法</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">then</span> = <span class="keyword">function</span>(<span class="params">onResolve, onReject</span>) &#123;</span><br><span class="line">        onResolve_ = onResolve</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 在resolve内部必定要执行demo.then()绑定的onResolve()函数，因此让resolve中的onResolve_()函数延后执行</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">resolve</span>(<span class="params">value</span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="title function_">onResolve_</span>(value)</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// onResolve_(value)</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">executor</span>(resolve, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">executor</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">    <span class="title function_">resolve</span>(<span class="number">100</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> demo = <span class="keyword">new</span> <span class="title class_">Bromise</span>(executor)</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onResolve</span>(<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">&#125;</span><br><span class="line">demo.<span class="title function_">then</span>(onResolve)</span><br></pre></td></tr></table></figure>

<p>实际上，由于定时器的效率不是很高，因此Promise将这个定时器改造成了微任务，进一步提升了代码执行效率。</p>
<h3 id="async与await——同步代码书写异步操作"><a href="#async与await——同步代码书写异步操作" class="headerlink" title="async与await——同步代码书写异步操作"></a>async与await——同步代码书写异步操作</h3><p>先来看一段Promise异步操作代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">fetch</span>(<span class="string">&#x27;https://www.geekbang.org&#x27;</span>)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(response)</span><br><span class="line">          <span class="keyword">return</span> <span class="title function_">fetch</span>(<span class="string">&#x27;https://www.geekbang.org/test&#x27;</span>)</span><br><span class="line">      &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(response)</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(error)</span><br><span class="line">      &#125;)</span><br></pre></td></tr></table></figure>

<p>虽然和回调地狱相比，Promise已然改进了不少了，但是promise.then()方法的链式调用也显得代码有一点凌乱。因此，我们引入ES7的新语法特性——async&#x2F;await——它支持我们在不阻塞主线程的情况下使用同步代码实现异步访问资源的能力：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> response1 = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;https://www.geekbang.org&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;response1&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response1)</span><br><span class="line">    <span class="keyword">let</span> response2 = <span class="keyword">await</span> <span class="title function_">fetch</span>(<span class="string">&#x27;https://www.geekbang.org/test&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;response2&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response2)</span><br><span class="line">  &#125;<span class="keyword">catch</span>(err) &#123;</span><br><span class="line">       <span class="variable language_">console</span>.<span class="title function_">error</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>()</span><br></pre></td></tr></table></figure>



<h4 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h4><p>在进一步学习async&#x2F;await之前，我们需要先了解生成器函数。</p>
<blockquote>
<p>生成器函数：</p>
<ol>
<li>在生成器函数内部执行一段代码，如果遇到 yield 关键字，那么 JavaScript 引擎将返回关键字后面的内容给外部，并暂停该函数的执行。</li>
<li>外部函数可以通过 next 方法恢复函数的执行。</li>
</ol>
<p>为了理解生成器函数的实现原理，这里简单介绍一个概念——协程。简单而言，协程是跑在线程上的任务，是一种比线程更加轻量级的存在。虽然一个线程上可以存在多个协程，但是同时只能执行一个协程。</p>
</blockquote>
<p>通过生成器配合Promise改造代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span>* <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> response1 = <span class="keyword">yield</span> <span class="title function_">fetch</span>(<span class="string">&#x27;https://www.geekbang.org&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;response1&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response1);</span><br><span class="line">    <span class="keyword">let</span> response2 = <span class="keyword">yield</span> <span class="title function_">fetch</span>(<span class="string">&#x27;https://www.geekbang.org/test&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;response2&#x27;</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行foo函数的代码，创建gen协程</span></span><br><span class="line"><span class="keyword">let</span> gen = <span class="title function_">foo</span>()</span><br><span class="line"><span class="comment">// 继续执行foo函数，将主线程控制权交给gen协程</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getGenPromise</span>(<span class="params">gen</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> gen.<span class="title function_">next</span>().<span class="property">value</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">getGenPromise</span>(gen).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;response1&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">getGenPromise</span>(gen)</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;response2&#x27;</span>)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(response)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>其实，async、await的底层原理就是生成器与Promise。</p>
<h4 id="神奇的语法糖"><a href="#神奇的语法糖" class="headerlink" title="神奇的语法糖"></a>神奇的语法糖</h4><p>async、await两个关键字其实是语法糖，虽然看起来很简洁，实际上它们完成的工作量并不小。</p>
<ul>
<li>async：修饰函数，使之成为async函数，该函数通过异步执行并<strong>隐式返回Promise</strong>作为结果</li>
<li>await：顾名思义，它将“等待”一个Promise对象（或者其他值），如果是Promise对象，就返回其处理结果，如果是其他值，就返回其本身。<strong>await将会暂停当前async函数的执行，等待Promise的处理完成，此时主线程控制权转交给父协程，同时Promise也会进行处理</strong>。</li>
</ul>
<p>请看下面一个简单的示例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">let</span> a = <span class="keyword">await</span> <span class="number">100</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a)</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">0</span>)</span><br><span class="line"><span class="title function_">foo</span>()</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">3</span>)</span><br><span class="line"><span class="comment">/*运行结果为：</span></span><br><span class="line"><span class="comment">0</span></span><br><span class="line"><span class="comment">1</span></span><br><span class="line"><span class="comment">3</span></span><br><span class="line"><span class="comment">100</span></span><br><span class="line"><span class="comment">2</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>主线程中，0首先被打印；程序进入foo()，打印1，let a &#x3D; await 100，则当前async函数被停止，程序继续往下执行，即打印3，同时由于100并不是Promise对象，故a就是100本身，只不过会经过Promise处理，故在3打印后，100被打印，接着再继续执行foo，打印2。</p>
<h2 id="浏览器中的页面"><a href="#浏览器中的页面" class="headerlink" title="浏览器中的页面"></a>浏览器中的页面</h2><h3 id="开发者工具——网络面板"><a href="#开发者工具——网络面板" class="headerlink" title="开发者工具——网络面板"></a>开发者工具——网络面板</h3><p>我们重点来了解一下网络面板的时间线面板（Timing）。</p>
<p>打开网络面板（Network），在详细列表中点击某一个任务，可以发现该项的详细信息（Headers、Preview、Response、Timing），打开Timing，我们会发现如下选项：</p>
<ul>
<li>Queueing：浏览器发起一个请求时，有多种原因导致其不能被立即执行而进入排队等待状态，比如<ul>
<li>页面中资源具有优先级，图片、视频等资源优先级就比较低；</li>
<li>浏览器为每一个域名最多维护6个TCP连接；</li>
<li>网络进程为数据分配磁盘空间时，新的HTTP请求需要短暂地等待磁盘分配结果</li>
</ul>
</li>
<li>Stalled：等待排队完成后、发起连接之前，可能有一些原因导致连接过程被推迟，这就是Stalled，停滞</li>
<li>Initial connection&#x2F;SSL：和服务器建立连接</li>
<li>Request sent：网络进程发送请求，这个阶段很快</li>
<li>Waiting（TTFB）：也称第一字节时间，是反映服务端响应速度的重要指标，指等待接收服务器第一个字节数据</li>
<li>Content Download：陆续接收完整数据</li>
</ul>
<h3 id="DOM树与JavaScript"><a href="#DOM树与JavaScript" class="headerlink" title="DOM树与JavaScript"></a>DOM树与JavaScript</h3><h4 id="DOM树的生成简介"><a href="#DOM树的生成简介" class="headerlink" title="DOM树的生成简介"></a>DOM树的生成简介</h4><p>我们知道，在使用浏览器访问网页时，是由浏览器先向服务器发起网络请求，拿到网页源代码，然后生成各式各样的网页，供给客户端查看。从进程角度看，这涉及了两个重要的进程——网络进程、渲染进程。</p>
<p>网络进程和渲染进程之间会建立一个共享数据的管道，网络进程将拿到的数据放进该管道，而另一边的渲染进程则从管道的另外一端不断地读取数据，将其丢给HTML解析器，由其生成DOM。</p>
<blockquote>
<p>其实，网络进程拿过来的数据是字节流形式的，可以理解为页面源代码，也就是说，HTML解析器拿到的第一手数据也是字节流，需要先将字节流转化为Token，再将Token转化为DOM节点，并添加到DOM树上。</p>
</blockquote>
<p>第一部分，HTML解析器会维护一个Token栈，用以保存当前解析到的标签。</p>
<ul>
<li>如果解析到的是StartToken，就将其入栈，同时为该Token创建一个DOM节点；</li>
<li>如果解析到的是一个TextToken，不用入栈，直接创建文本节点，加入到DOM树中；</li>
<li>如果解析到的是EndToken，此时与栈顶元素匹配，将栈顶元素（StartToken）弹出，表示该元素标签封闭，解析完成。</li>
</ul>
<h4 id="JavaScript会阻塞DOM的生成"><a href="#JavaScript会阻塞DOM的生成" class="headerlink" title="JavaScript会阻塞DOM的生成"></a>JavaScript会阻塞DOM的生成</h4><p>网络进程传输给渲染进程的字节流中不一定全部都是html代码，也可能包括JavaScript脚本代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> div1 = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>)[<span class="number">0</span>]</span></span><br><span class="line"><span class="language-javascript">    div1.<span class="property">innerText</span> = <span class="string">&#x27;time.geekbang&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>test<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当HTML解析器解析到script标签时，会发现这是JavaScript代码，由于它有可能操作DOM，因此HTML解析器停止解析，转而由JavaScript引擎介入，在执行JavaScript代码（修改了文本节点的内容）后，HTML解析器恢复解析，继续工作。</p>
<p>那如果拿到的JavaScript代码以文件形式被引入呢？</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&#x27;foo.js&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>test<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里，JavaScript文件需要被下载，该下载过程会阻塞HTML的解析。Chrome对此做出的优化是，在渲染引擎收到字节流后，就会开启一个预解析线程，用于下载HTML中包含的JavaScript、CSS等相关文件。</p>
<h4 id="CSS样式表文件会阻塞JavaScript的执行"><a href="#CSS样式表文件会阻塞JavaScript的执行" class="headerlink" title="CSS样式表文件会阻塞JavaScript的执行"></a>CSS样式表文件会阻塞JavaScript的执行</h4><p>那接下来我们再来分析另外一种情况。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span> <span class="attr">src</span>=<span class="string">&#x27;theme.css&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> div1 = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>)[<span class="number">0</span>]</span></span><br><span class="line"><span class="language-javascript">            div1.<span class="property">innerText</span> = <span class="string">&#x27;time.geekbang&#x27;</span> <span class="comment">// 需要 DOM</span></span></span><br><span class="line"><span class="language-javascript">            div1.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;red&#x27;</span>  <span class="comment">// 需要 CSSOM</span></span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>test<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在script标签中，出现了操作css样式的JavaScript代码，也就是说在执行JavaScript之前，还需要解析所有的CSS样式。</p>
<p>但是实际上，JavaScript引擎在解析JavaScript之前，并不知道JavaScript是否操作了CSSOM，因此渲染引擎在遇到JavaScript脚本时，不论其是否操作CSSOM，都会执行CSS文件下载、解析CSS，然后再执行JavaScript脚本。</p>
<h4 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h4><p>如下代码，分析浏览器中的运行情况。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> div1 = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>)[<span class="number">0</span>]</span></span><br><span class="line"><span class="language-javascript">    div1.<span class="property">innerText</span> = <span class="string">&#x27;time.geekbang&#x27;</span></span></span><br><span class="line"><span class="language-javascript"> </span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> div2 = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;div&#x27;</span>)[<span class="number">1</span>]</span></span><br><span class="line"><span class="language-javascript">    div2.<span class="property">innerText</span> = <span class="string">&#x27;time.geekbang.com&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>test<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>之前提到过，JavaScript会阻塞DOM树的生成，因此HTML解析器解析到script标签的时候，会停止解析，交给JavaScript引擎。而此时DOM树中仅有一个div节点，因此div1有值，div2并不会拿到值，进而拿不到它的innerText属性，会报错。</p>
<p>JavaScript引擎将JavaScript代码执行完毕后，HTML解析器继续执行，将剩余的div解析出来，但是文本内容就是test，不会被改变。</p>
<h3 id="CSS动画"><a href="#CSS动画" class="headerlink" title="CSS动画"></a>CSS动画</h3><h4 id="显示器显示图像"><a href="#显示器显示图像" class="headerlink" title="显示器显示图像"></a>显示器显示图像</h4><p>显示器每秒固定读取一定次数前缓冲区的图像到显示器上，而显卡的职责是合成新的图像，并将图像保存到后缓冲区中，之后系统会让后缓冲区和前缓冲区互换，保证显示器能够读取最新显卡合成的图像。这样一来，通常情况下，显卡的更新频率和显示器的刷新频率一致。</p>
<h4 id="帧与帧率"><a href="#帧与帧率" class="headerlink" title="帧与帧率"></a>帧与帧率</h4><p>我们把渲染流水线生成的每一幅图片称为一帧，把渲染流水线每秒更新了多少帧称为帧率。</p>
<h3 id="虚拟DOM"><a href="#虚拟DOM" class="headerlink" title="虚拟DOM"></a>虚拟DOM</h3><p>当DOM结构较为复杂时，不断地修改DOM树会导致重排、重绘等操作，给渲染器增加负担。因此，虚拟DOM的出现，就是想尽可能地减少对真实DOM的操作次数。</p>
<h4 id="虚拟DOM用来干什么"><a href="#虚拟DOM用来干什么" class="headerlink" title="虚拟DOM用来干什么"></a>虚拟DOM用来干什么</h4><p>虚拟DOM其实可以理解为真实DOM之前的一个存在，在页面数据发生变化时，先重新创建出新的虚拟DOM树，然后与旧的DOM树进行比较，将变化的节点一次性全部应用到真实DOM树上，完成修改。</p>
<h4 id="从双缓存视角看虚拟DOM"><a href="#从双缓存视角看虚拟DOM" class="headerlink" title="从双缓存视角看虚拟DOM"></a>从双缓存视角看虚拟DOM</h4><p>缓冲区其实是一个方便计算机快速处理的机制。但有时候，如果将数据一部分一部分地写入缓冲区，就会导致页面上的信息一块一块地显示出来，带给用户不良的体验。因此，<strong>双缓存</strong>发挥了优势：<br>先将计算的中间结果存放在另一个缓冲区中，待全部计算结束，缓冲区已经存储了完整的数据之后（比如完整的图像数据信息），一次性复制到显示缓冲区，这样就会使得整个数据输出十分稳定。<br>这里的虚拟DOM就是一种类似双缓存的机制。</p>
<h4 id="MVC模式"><a href="#MVC模式" class="headerlink" title="MVC模式"></a>MVC模式</h4><ul>
<li>M：model，模型，可以理解为数据</li>
<li>V：view，视图，可以理解为人眼看到的画面</li>
<li>C：controller，控制器，是连接model与view的枢纽</li>
</ul>
<p>通过MVC模式来看，</p>
<ul>
<li>虚拟DOM实际上是MVC的<strong>视图</strong>部分，因为它将涉及后续视图的更新</li>
<li>控制器用于监视DOM的变化，一旦DOM变化了，控制器就会通知模型，让其更新（update）数据</li>
<li>模型数据更新好后，控制器会通知视图，告知（notify）其数据模型已经变化</li>
<li>视图收到消息，会根据新的数据来生成新的虚拟DOM</li>
<li>新的虚拟DOM一旦生成，会与旧的虚拟DOM进行比较，将变化的节点应用到真实DOM上</li>
</ul>
<h3 id="WebComponent——组件化"><a href="#WebComponent——组件化" class="headerlink" title="WebComponent——组件化"></a>WebComponent——组件化</h3><p>组件可以理解为具有某一个特定功能的“工具”，它高内聚、低耦合，在多人协作开发中可以被方便地复用，极大地提高了开发效率。</p>
<p>对于大多数编程语言，都可以实现组件化——凭借其类、作用域等特性，实现模块的封装等等，JavaScript也不例外。但是，在前端开发中，仍然存在着阻碍组件化开发的因素。</p>
<ul>
<li>CSS对标签属性的控制：css代码的标签选择器对全局标签进行选择，并设置属性，这样一来，不同开发人员编写的某一元素的样式可能会被全部修改。</li>
<li>DOM的阻碍：全局DOM只有一个，但是任意一个地方都可以修改DOM。</li>
</ul>
<p>对此，WebComponent提出了解决思路，提供了对局部视图封装能力——Web Components技术，它由三项主要技术组成：</p>
<ul>
<li>自定义元素（Custom elements）：一组JavaScript API</li>
<li>影子DOM（Shadow DOM）：一组JavaScript API，将封装的影子DOM树附加到元素（与主文档DOM分开呈现），这样可以保持元素功能私有</li>
<li>HTML模板（HTML templates）</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">template</span> <span class="attr">id</span>=<span class="string">&quot;geekbang-t&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">p</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">background-color</span>: brown;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">color</span>: coral;</span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">            <span class="selector-tag">div</span> &#123;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">width</span>: <span class="number">200px</span>;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">background-color</span>: bisque;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">border</span>: <span class="number">3px</span> solid chocolate;</span></span><br><span class="line"><span class="language-css">                <span class="attribute">border-radius</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            &#125;</span></span><br><span class="line"><span class="language-css">        </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>time.geekbang.org<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>time1.geekbang.org<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;inner log&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">class</span> <span class="title class_">GeekBang</span> <span class="keyword">extends</span> <span class="title class_ inherited__">HTMLElement</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">super</span>()</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 这里的content就是template下所有的html内容</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> content = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#geekbang-t&#x27;</span>).<span class="property">content</span></span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">const</span> shadowDOM = <span class="variable language_">this</span>.<span class="title function_">attachShadow</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="attr">mode</span>: <span class="string">&#x27;open&#x27;</span></span></span><br><span class="line"><span class="language-javascript">                &#125;)</span></span><br><span class="line"><span class="language-javascript">                <span class="variable language_">console</span>.<span class="title function_">log</span>(shadowDOM);</span></span><br><span class="line"><span class="language-javascript">                shadowDOM.<span class="title function_">appendChild</span>(content.<span class="title function_">cloneNode</span>(<span class="literal">true</span>))</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        customElements.<span class="title function_">define</span>(<span class="string">&#x27;geek-bang&#x27;</span>, <span class="title class_">GeekBang</span>)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">geek-bang</span>&gt;</span><span class="tag">&lt;/<span class="name">geek-bang</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>time.geekbang.org<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>time1.geekbang.org<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">geek-bang</span>&gt;</span><span class="tag">&lt;/<span class="name">geek-bang</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>要使用Web Component，通常要实现下面三个步骤：</p>
<ol>
<li><p>使用template属性来创建模板。实际上，模板元素内容并不会被渲染到页面上，也就是说template节点不会出现在布局树中。</p>
</li>
<li><p>创建一个GeekBang类。这个类的构造函数中完成三件事：</p>
<ul>
<li>查找模板内容</li>
<li>创建影子DOM</li>
<li>再将模板添加到影子DOM上</li>
</ul>
<blockquote>
<p>影子DOM，将模板中的内容与全局DOM和CSS进行隔离，实现元素和样式的私有化。</p>
</blockquote>
</li>
<li><p>上面两步实现后，就可以像正常使用HTML元素一样使用该元素，如&lt;geek-bang&gt;&lt;&#x2F;geek-bang&gt;</p>
</li>
</ol>
<h2 id="浏览器中的网络"><a href="#浏览器中的网络" class="headerlink" title="浏览器中的网络"></a>浏览器中的网络</h2><h3 id="HTTP性能优化"><a href="#HTTP性能优化" class="headerlink" title="HTTP性能优化"></a>HTTP性能优化</h3><blockquote>
<p>HTTP是浏览器最重要且使用最多的协议，是浏览器和服务器之间的通信语言。随着互联网的发展，HTTP也在持续进化。</p>
</blockquote>
<h4 id="HTTP-x2F-0-9"><a href="#HTTP-x2F-0-9" class="headerlink" title="HTTP&#x2F;0.9"></a>HTTP&#x2F;0.9</h4><p>用途较为简单，主要用于学术交流，需求也很简单，只需要在网络之间传递HTML超文本内容，故称“超文本传输协议”。</p>
<ul>
<li>客户端根据IP地址、端口、服务器建立TCP连接，涉及TCP协议三次握手过程；</li>
<li>TCP连接建立完成后，发送应该GET请求行信息，如<code>GET /index.html</code>用来获取index.html；</li>
<li>服务器接收请求信息之后，读取对应的HTML文件，并将数据以ASCII字符流返回给客户端；</li>
<li>传输完成，连接断开。</li>
</ul>
<h4 id="HTTP-x2F-1-0"><a href="#HTTP-x2F-1-0" class="headerlink" title="HTTP&#x2F;1.0"></a>HTTP&#x2F;1.0</h4><p>万维网的高速发展带来了很多新需求，HTTP&#x2F;0.9已经不再适用于新的网络发展了。新的需求包括：</p>
<ul>
<li>浏览器中展示的不单单是HTML文件了，还有JavaScript、CSS、图片、音视频等不同类型的文件。</li>
<li>文件格式不仅仅局限于ASCII编码，还有很多其他类型编码的文件。</li>
</ul>
<p>为了<strong>支持对多种类型文件的下载</strong>，HTTP&#x2F;1.0引入了<strong>请求头和响应头</strong>，也就是说，在HTTP发送请求时，会带上请求头信息，服务器返回数据时，会先返回响应头信息。</p>
<blockquote>
<p>HTTP&#x2F;1.0通过请求头、响应头支持多种不同类型的数据的原理：</p>
<p>HTTP在发起请求时候会通过HTTP<strong>请求头</strong>告诉服务器它期待服务器</p>
<ul>
<li>返回什么类型的文件</li>
<li>采取什么形式的压缩</li>
<li>提供什么语言的文件以及编码</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">accept</span>: text/html	<span class="comment">// 期望浏览器返回html类型文件</span></span><br><span class="line">accept-<span class="attr">encoding</span>: gzip, deflate, br	<span class="comment">// 期望浏览器采用gzip、deflate或者br压缩方式</span></span><br><span class="line">accept-<span class="title class_">Charset</span>: <span class="variable constant_">ISO</span>-<span class="number">8859</span>-<span class="number">1</span>,utf-<span class="number">8</span>	<span class="comment">// 期望返回的文件编码是UTF-8或者ISO-8859-1</span></span><br><span class="line">accept-<span class="attr">language</span>: zh-<span class="variable constant_">CN</span>,zh	<span class="comment">// 期望页面的优先语言是中文</span></span><br></pre></td></tr></table></figure>

<p>服务器接收到浏览器发送过来的请求头信息之后，就会根据请求头的信息准备响应数据，并将相关信息以响应头形式反馈给客户端浏览器（按要求做事情，并给出反馈）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">content-<span class="attr">encoding</span>: br	<span class="comment">// 服务器采用了br压缩方法</span></span><br><span class="line">content-<span class="attr">type</span>: text/html; charset=<span class="variable constant_">UTF</span>-<span class="number">8</span>	<span class="comment">// 服务器返回html文件，编码类型为UTF-8</span></span><br></pre></td></tr></table></figure>

<p>拿到如上的服务器响应头信息后，最终浏览器需要根据响应头的信息来处理数据。</p>
</blockquote>
<p>此外，HTTP&#x2F;1.0还引入了很多其他的特性，比如</p>
<ul>
<li>状态码——通过响应行的方式通知浏览器，服务器最终处理情况</li>
<li>Cache机制——缓存已经下载过的数据，减轻服务器压力</li>
<li>用户代理字段——服务器需要统计客户端的基础信息</li>
</ul>
<h4 id="HTTP-x2F-1-1"><a href="#HTTP-x2F-1-1" class="headerlink" title="HTTP&#x2F;1.1"></a>HTTP&#x2F;1.1</h4><p>相比于HTTP&#x2F;1.0，1.1有如下方面的改进：</p>
<ul>
<li>改进持久连接</li>
</ul>
<p>在HTTP&#x2F;1.0中，一次HTTP通信，需要经历<strong>建立TCP连接、传输HTTP数据和断开TCP连接</strong>三个阶段。但是随着单个页面中文件数量增多，每一次下载文件都需要重复这三个步骤，无疑会增加大量开销。</p>
<p>对此，HTTP&#x2F;1.1中增加了持久连接，在应该TCP连接上可以传输多个HTTP请求，只要浏览器或者服务器没有断开连接，该TCP连接会一直保持。</p>
<p>另外，浏览器为每个域名最多同时维护6个TCP持久连接。</p>
<ul>
<li>不成熟的HTTP管线化</li>
</ul>
<p>TCP通道中一旦某个请求因为某些原因没有及时返回，就会阻塞后面的所有请求——队头阻塞问题。对此，HTTP&#x2F;1.1中试图引入管线化技术来解决队头阻塞问题。</p>
<ul>
<li>引入客户端Cookie与安全机制</li>
</ul>
<p>但是，HTTP&#x2F;1.1仍然有很大的不足，核心问题在于<strong>对带宽的利用率并不理想</strong>。</p>
<blockquote>
<p>带宽，是指每秒最大能够发送或者接收的字节数。每秒能够发送的最大字节数称为上行带宽，每秒能够接收的最大字节数称为下行带宽。</p>
</blockquote>
<p>原因主要有三点：</p>
<ol>
<li>TCP慢启动。TCP连接建立之后，会进入发送数据状态，刚开始TCP协议会采用应该非常慢的速度去发送数据。</li>
<li>同时开启多条TCP连接会竞争固定的带宽。</li>
<li>HTTP&#x2F;1.1的队头阻塞问题。</li>
</ol>
<h4 id="HTTP-x2F-2"><a href="#HTTP-x2F-2" class="headerlink" title="HTTP&#x2F;2"></a>HTTP&#x2F;2</h4><p>那么如何解决HTTP&#x2F;1.1的问题呢？</p>
<p>我们先分析上面的三点原因，会发现，第一条、第二条是TCP本身的机制引起的，第三条是HTTP&#x2F;1.1的机制导致的。</p>
<p>因此，HTTP&#x2F;2的思路就是<strong>一个域名只使用一个TCP长连接来传输数据</strong>，这样整个页面资源的下载过程只需要一次慢启动，也不会有多个TCP连接竞争问题。</p>
<p>此外，HTTP&#x2F;2最核心的功能是<strong>多路复用机制</strong>——引入二进制分帧层，实现了资源的并行传输。</p>
<p>当然，HTTP&#x2F;2还有一些其他特性，比如</p>
<ul>
<li>可以设置请求的优先级：在发送请求时，可以标上该请求的优先级</li>
<li>服务器推送：直接将数据提前推送到浏览器</li>
<li>头部压缩：对请求头和响应头都进行了压缩</li>
</ul>
<h2 id="浏览器安全"><a href="#浏览器安全" class="headerlink" title="浏览器安全"></a>浏览器安全</h2><h3 id="Web页面安全"><a href="#Web页面安全" class="headerlink" title="Web页面安全"></a>Web页面安全</h3><p>Web页面安全的意义在于可以保障我们的隐私和数据的安全。</p>
<p>Web页面安全中最基础、最核心的安全策略——同源策略。</p>
<p>同源是针对URL而言的，<strong>如果两个 URL 的协议、域名和端口都相同，我们就称这两个 URL 同源</strong>。比如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">https</span>:<span class="comment">//time.geekbang.org/?category=1</span></span><br><span class="line"><span class="attr">https</span>:<span class="comment">//time.geekbang.org/?category=0</span></span><br></pre></td></tr></table></figure>

<p>而同源策略就是，两个不同的源之间如果想要互相访问资源或者操作DOM，就会有一套基础的安全策略的制约。</p>
<p>同源策略会隔离不同源的DOM、页面数据和网络通信，进而实现Web页面的安全性。</p>
<p>但是，安全性和便利性是相互对立的。对此浏览器出让一些安全性来满足灵活性，以方便Web开发。浏览器出让了同源策略的哪些安全性呢？</p>
<ol>
<li>页面中可以嵌入第三方资源</li>
</ol>
<p>最初的浏览器都是支持外部引用资源文件的，不过这也带来了很多问题。最多的问题是，浏览器的首页内容会被一些恶意程序劫持，其中，最常见的是恶意程序通过各种途径往HTML文件中插入恶意脚本。</p>
<p>对此，我们引入了CSP策略来加以限制。</p>
<ol start="2">
<li>跨域资源共享和跨文档消息机制</li>
</ol>
<p>跨域资源共享，CORS，允许进行跨域访问控制；</p>
<p>跨文档消息机制，允许两个不同源的DOM之间进行通信。</p>
<h3 id="跨站脚本攻击——XSS攻击"><a href="#跨站脚本攻击——XSS攻击" class="headerlink" title="跨站脚本攻击——XSS攻击"></a>跨站脚本攻击——XSS攻击</h3><h4 id="XSS攻击以及危害"><a href="#XSS攻击以及危害" class="headerlink" title="XSS攻击以及危害"></a>XSS攻击以及危害</h4><p>首先我们需要知道什么是XSS。XSS，Cross Site Scripting，为了区分于CSS，故称XSS，意为“跨站脚本”。<strong>所谓XSS攻击，指黑客往HTML文件中或者DOM中注入恶意脚本，从而在用户浏览页面时利用注入的恶意脚本对用户实施攻击的一种手段</strong>。</p>
<p>HTML文件中注入恶意代码会给用户带来很多危害。比如</p>
<ul>
<li><p>窃取Cookie信息。</p>
<p>恶意的JavaScript通过document.cookie来获取Cookie信息，然后通过XMLHttpRequest或者Fetch加上CORS功能将数据发送给恶意服务器。恶意服务器一旦拿到用户的Cookie信息，也即掌握了用户的账户等隐私信息，几乎可以为所欲为。</p>
</li>
<li><p>监听用户行为。</p>
<p>恶意JavaScript通过addEventListener接口来监听键盘事件，比如可以获取用户输入的信用卡等信息。</p>
</li>
<li><p>伪造假的登录窗口。</p>
<p>恶意代码修改DOM，属于欺骗用户行为。</p>
</li>
<li><p>生成浮窗广告。</p>
</li>
</ul>
<h4 id="恶意脚本的注入"><a href="#恶意脚本的注入" class="headerlink" title="恶意脚本的注入"></a>恶意脚本的注入</h4><p>要想避免站点被注入恶意脚本，就要知道有哪些常见的注入方式：</p>
<ul>
<li>存储型XSS攻击</li>
<li>反射型XSS攻击</li>
<li>基于DOM的XSS攻击</li>
</ul>
<h5 id="存储型XSS攻击"><a href="#存储型XSS攻击" class="headerlink" title="存储型XSS攻击"></a>存储型XSS攻击</h5><ul>
<li>黑客首先利用站点漏洞，将一段恶意JavaScript代码提交到网站的数据库中</li>
<li>用户向网站请求包含了恶意JavaScript脚本的页面</li>
<li>用户浏览该页面，恶意脚本上传用户的Cookie等信息</li>
</ul>
<h5 id="反射型xss攻击"><a href="#反射型xss攻击" class="headerlink" title="反射型xss攻击"></a>反射型xss攻击</h5><p>恶意JavaScript脚本属于用户发送给网站请求中的一部分，随后网站又把JavaScript脚本返回给用户了。</p>
<p><strong>Web 服务器不会存储反射型 XSS 攻击的恶意脚本，这是和存储型 XSS 攻击不同的地方</strong>。</p>
<h5 id="基于DOM的XSS攻击"><a href="#基于DOM的XSS攻击" class="headerlink" title="基于DOM的XSS攻击"></a>基于DOM的XSS攻击</h5><p>不牵涉页面Web服务器，具体来讲，黑客通过各种手段将恶意脚本注入用户的页面中，比如网络劫持等。</p>
<h4 id="阻止XSS攻击"><a href="#阻止XSS攻击" class="headerlink" title="阻止XSS攻击"></a>阻止XSS攻击</h4><p>无论是何种类型的 XSS 攻击，它们都有一个共同点，那就是首先往浏览器中注入恶意脚本，然后再通过恶意脚本将用户信息发送至黑客部署的恶意服务器上。所以要阻止 XSS 攻击，<strong>我们可以通过阻止恶意 JavaScript 脚本的注入和恶意消息的发送来实现</strong>。</p>
<ul>
<li><p>服务器对输入脚本进行过滤或者转码</p>
</li>
<li><p>充分利用CSP</p>
<blockquote>
<p>CSP，Content Security Policy，即内容安全策略，其主要目标是减少和报告XSS攻击。其实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以被加载和执行（提供白名单）。</p>
</blockquote>
</li>
<li><p>使用HttpOnly属性</p>
<p>使用HttpOnly标记的Cookie只能使用在HTTP请求过程中，无法通过JavaScript来读取（document.cookie）。</p>
</li>
</ul>
<h3 id="CSRF攻击"><a href="#CSRF攻击" class="headerlink" title="CSRF攻击"></a>CSRF攻击</h3><p>CSRF，Cross-site request forgery，又称“跨站请求伪造”，指黑客引诱用户打开黑客的网站，在黑客的网站中，利用用户的登录状态发起的跨站请求。</p>
<h3 id="页面安全和操作系统安全"><a href="#页面安全和操作系统安全" class="headerlink" title="页面安全和操作系统安全"></a>页面安全和操作系统安全</h3><h4 id="初代浏览器的架构"><a href="#初代浏览器的架构" class="headerlink" title="初代浏览器的架构"></a>初代浏览器的架构</h4><p>最开始的阶段浏览器是单进程的，JavaScript执行、网络加载、UI绘制等过程都是在同一个进程中执行的，如此简单的结构却也带来了很多问题。首先，就是单进程架构的浏览器并不稳定。</p>
<p>浏览器进程中任意一个功能出现异常，都有可能影响到整个浏览器。而如果浏览器存在漏洞，黑客有可能通过恶意的页面向浏览器中注入恶意程序，不仅如此，还可以穿透浏览器，在用户的操作系统上悄悄地安装恶意软件、监听用户键盘输入以及读取硬盘上的文件内容。</p>
<h4 id="现代浏览器的两个核心模块"><a href="#现代浏览器的两个核心模块" class="headerlink" title="现代浏览器的两个核心模块"></a>现代浏览器的两个核心模块</h4><p>现代浏览器采用了多进程架构，将渲染进程和浏览器主进程分离开来。浏览器被划分为</p>
<ul>
<li>浏览器内核<ul>
<li>网络进程</li>
<li>浏览器主进程</li>
<li>GPU进程</li>
</ul>
</li>
<li>渲染内核<ul>
<li>渲染进程</li>
</ul>
</li>
</ul>
<p>当我们打开一个页面时，这两个模块就会互相配合。</p>
<ul>
<li>首先，浏览器内核会下载所有的网络资源，下载后的资源会通过IPC将其提交给渲染进程（IPC是浏览器内核和渲染进程的通信通道）；</li>
<li>然后渲染进程会对这些资源进行解析、绘制等操作，最终生成一幅图片；</li>
<li>这张生成的图片会被提交给浏览器内核模块，由浏览器内核模块负责显示这张图片。</li>
</ul>
<h4 id="安全沙箱"><a href="#安全沙箱" class="headerlink" title="安全沙箱"></a>安全沙箱</h4><p>渲染进程执行下载的各种网络资源时，需要十分小心，否则容易执行恶意程序，进而被黑客攻击。对此，我们需要在渲染进程和操作系统之间建立一道墙，即使渲染进程由于存在漏洞被黑客攻击，但由于这道墙的存在，黑客获取不到渲染进程之外的任何操作权限——这道墙就是安全沙箱。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://luqingbys.github.io/mid-lake-pavilion.github.io/2022/02/10/%E6%B5%8F%E8%A7%88%E5%99%A8/" data-id="cl17apw37003wicud4qfvdq3s" data-title="浏览器" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/mid-lake-pavilion.github.io/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" rel="tag">浏览器</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Flask基础" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/mid-lake-pavilion.github.io/2022/02/06/Flask%E5%9F%BA%E7%A1%80/" class="article-date">
  <time class="dt-published" datetime="2022-02-06T08:25:57.000Z" itemprop="datePublished">2022-02-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/mid-lake-pavilion.github.io/2022/02/06/Flask%E5%9F%BA%E7%A1%80/">Flask基础</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="第一个程序"><a href="#第一个程序" class="headerlink" title="第一个程序"></a>第一个程序</h2><p>Flask是基于Python的web开发框架。</p>
<p>从最基本的Flask代码开始吧：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">   app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>运行如上代码，就可以在浏览器中看到运行结果——Hello，Flask!</p>
<ul>
<li><p>第二行调用Flask()构造函数，返回的是一个application对象；</p>
</li>
<li><p>url ‘&#x2F;‘绑定到了hello_world()上面；</p>
</li>
<li><p>在上面的示例中，run()方法用于在本地服务器上运行应用程序，其函数原型为：<br>app.run(host, port, debug, options)</p>
</li>
<li><p>host，指定主机端口号</p>
</li>
<li><p>port，端口号</p>
</li>
<li><p>debug，是否启用调试模式</p>
</li>
</ul>
<h2 id="Flask路由"><a href="#Flask路由" class="headerlink" title="Flask路由"></a>Flask路由</h2><p>在Web应用中，不同的url对应不同的页面；Flask中的route()装饰器用于将URL绑定到函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hello&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_flask</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello Flask&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>在上面的代码示例中，route()装饰器将URL‘&#x2F;hello’规则绑定到了hello_flask()函数，如果用户访问<br><a target="_blank" rel="noopener" href="http://localhost:5000/hello">http://localhost:5000/hello</a> ，hello_flask()函数的输出就将在浏览器中呈现。</p>
<p>当然，也可以不使用装饰器写法，改用application对象的add_url_rule()函数也可以实现URL与函数的绑定：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hello_flask</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;hello flask!&#x27;</span></span><br><span class="line">app.add_url_rule(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;hello&#x27;</span>, hello_flask)</span><br></pre></td></tr></table></figure>

<h2 id="Flask变量规则——路由参数"><a href="#Flask变量规则——路由参数" class="headerlink" title="Flask变量规则——路由参数"></a>Flask变量规则——路由参数</h2><p>向规则参数添加变量部分，可以动态地构建URL。<br>此变量部分标记为 &lt; variable-name &gt;<br>示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/blog/&lt;int:postId&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_blog</span>(<span class="params">postId</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Blog Number %d&#x27;</span> % postId</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/rev/&lt;float:revNo&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">revision</span>(<span class="params">revNo</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Revision Number %f&#x27;</span> % revNo</span><br></pre></td></tr></table></figure>

<p>&lt; int:postId&gt;中，int是对变量类型postId的限制，我们在地址栏中输入&#x2F;blog&#x2F;9后，按下回车，屏幕上就会显示Blog Number 9。</p>
<ul>
<li>%d 整型</li>
<li>%f 浮点型</li>
<li>%s 字符串型</li>
</ul>
<h2 id="Flask-URL构建"><a href="#Flask-URL构建" class="headerlink" title="Flask URL构建"></a>Flask URL构建</h2><p>函数url_for()，用于动态构建特定函数的URL。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, redirect, url_for</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/admin&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_admin</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello Admin&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/guest/&lt;guest&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_guest</span>(<span class="params">guest</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Hello %s as Guest&#x27;</span> % guest</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/user/&lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_user</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">&#x27;admin&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;hello_adminn&#x27;</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;hello_guest&#x27;</span>, guest=name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>在&#x2F;user&#x2F;…对应的函数hello_user中，我们作出了处理：<br>如果接收参数为字符串admin，就重定向到hello_admin()函数否则重定向到hello_guest()函数。</p>
<h2 id="Flask中的HTTP"><a href="#Flask中的HTTP" class="headerlink" title="Flask中的HTTP"></a>Flask中的HTTP</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://localhost:5000/login&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Enter Name:<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;nm&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们创建一个html文件，在其中写一个表单，在下面的文件中接收表单提交到服务器的数据。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在Flask中使用HTTP方法</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, redirect, url_for, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/success/&lt;name&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">success</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;welcome %s&#x27;</span> % name</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="comment"># 通过表单拿到输入的名字，并给动态URL</span></span><br><span class="line">        user = request.form[<span class="string">&#x27;nm&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;success&#x27;</span>, name=user))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        user = request.args.get(<span class="string">&#x27;nm&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;success&#x27;</span>, name=user))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><h3 id="模板的来历"><a href="#模板的来历" class="headerlink" title="模板的来历"></a>模板的来历</h3><p>之前与URL绑定的函数，叫做视图函数，一般来说，视图函数有两个作用：</p>
<ul>
<li>处理业务逻辑（背后的业务代码，也即展示出来的数据是怎么来的）</li>
<li>返回相应内容（将要展示的数据表现出来）</li>
</ul>
<p>在大型应用中，一般选择将业务逻辑与表现内容分开，否则代码极其复杂，维护起来很困难。<br>因此，我们需要用到模板。</p>
<h3 id="何为模板"><a href="#何为模板" class="headerlink" title="何为模板"></a>何为模板</h3><p>模板，其实就是一个包含响应文本的文件，特殊的地方在于，里面有动态文本内容，使用占位符变量来表示，占位符变量可以告诉模板引擎该处的值需要从另外的地方获取数据；<br>另外，从视图函数中的真实值，替换模板中的占位符变量，这个过程简单理解为“渲染”。<br>如此一来，模板的使用，就可以将业务逻辑与表现内容分离开来，使得</p>
<ul>
<li>视图函数只负责业务逻辑和数据处理</li>
<li>模板只负责从视图函数中获取数据进行展示</li>
</ul>
<p>举例：<br>我们在项目中单独创建templates文件夹，并在该目录下创建一个模板文件hello.html;</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>05_Flask模板<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    我的模板html内容</span><br><span class="line">    <span class="comment">&lt;!-- 注意，以下的双括号插值都是待加入的变量，从视图函数中得来 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#123;&#123; my_str &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#123;&#123; my_int &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#123;&#123; my_array &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span> /&gt;</span>&#123;&#123; my_dict &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>可以发现，模板文件中，占位符处的值需要从视图函数中获取对应的数据，下面是视图函数所在文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"><span class="keyword">from</span> sympy <span class="keyword">import</span> deg</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们向模板中传入字符串、列表、字典</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="comment"># 定义要往模板中传递的数据</span></span><br><span class="line">    my_str = <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">    my_int = <span class="number">10</span></span><br><span class="line">    my_array = [<span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">9</span>]</span><br><span class="line">    my_dict = &#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;xiaoming&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;age&#x27;</span>: <span class="number">18</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;hello.html&#x27;</span>,</span><br><span class="line">                           my_str=my_str,</span><br><span class="line">                           my_int=my_int,</span><br><span class="line">                           my_array=my_array,</span><br><span class="line">                           my_dict=my_dict</span><br><span class="line">                           )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h2 id="控制代码块写法"><a href="#控制代码块写法" class="headerlink" title="控制代码块写法"></a>控制代码块写法</h2><p>包括if写法（选择）、for写法（循环）。<br>演示相关的模板语法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 模板语法，使用&#123;# #&#125;表示注释 --&gt;</span></span><br><span class="line">    &#123;# 判断显示内容 #&#125;</span><br><span class="line">    &#123;% if name %&#125;</span><br><span class="line">    <span class="comment">&lt;!-- janjo模板语法，双括号插值写法，|后面跟一个函数（首字母大写） --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>hello &#123;&#123; name|capitalize &#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>请登录<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 选择代码块的结束标识 --&gt;</span></span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- for循环的使用 --&gt;</span></span><br><span class="line">    &#123;% for general in my_list %&#125;</span><br><span class="line">        &#123;&#123; general &#125;&#125; <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 循环代码块的结束标识 --&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>视图函数如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/control&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">control</span>():</span><br><span class="line">    my_list = [<span class="string">&#x27;徐达&#x27;</span>, <span class="string">&#x27;常遇春&#x27;</span>, <span class="string">&#x27;郭英&#x27;</span>, <span class="string">&#x27;蓝玉&#x27;</span>, <span class="string">&#x27;傅友德&#x27;</span>, <span class="string">&#x27;耿炳文&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;control.html&#x27;</span>, name=<span class="string">&#x27;xiaoming&#x27;</span>, my_list=my_list)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>过滤器的本质就是函数。它的作用在于“微调”，即有时候我们需要对模板中的数据做一定的修改，比如更改格式（首字母大写、日期格式等），在模板中自然不能直接调用Python方法，这样一来，就需要用到过滤器。<br>语法格式如下：</p>
<p><code>&#123;&#123; variable | filter_name(*args) &#125;&#125;</code><br>variable即为变量，filter_name即为过滤器函数，*args 为过滤器接收的参数<br>常见的内置过滤器有</p>
<ul>
<li>upper：字符串中全部字符大写</li>
<li>lower：字符串中全部字符小写</li>
<li>reverse：字符串反转</li>
<li>format：格式化输出</li>
<li>first：取列表的首元素</li>
<li>last：去列表的尾元素</li>
<li>length：得到列表长度</li>
<li>sum：得到列表所有元素之和</li>
<li>sort：列表排序</li>
</ul>
<p>等等。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    &#123;% for item in my_list %&#125;</span><br><span class="line">    <span class="comment">&lt;!-- upper为过滤器，表示将变量item全部大写 --&gt;</span></span><br><span class="line">        &#123;&#123; item | upper &#125;&#125;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_filter</span>():</span><br><span class="line">    my_list = [<span class="string">&#x27;www&#x27;</span>, <span class="string">&#x27;wanda&#x27;</span>, <span class="string">&#x27;amazi&#x27;</span>]</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;filter.html&#x27;</span>, my_list=my_list)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>


<h2 id="Flask-Request对象"><a href="#Flask-Request对象" class="headerlink" title="Flask Request对象"></a>Flask Request对象</h2><p>来自客户端网页的数据作为全局请求对象发送到服务器，为了处理请求数据，应该从Flask模块导入。</p>
<p>Request对象的重要属性如下：</p>
<ul>
<li>Form：字典对象，包含表单参数及其值的键、值；</li>
<li>args：解析查询字符串的内容，URL中？之后的部分；</li>
<li>Cookies：保存Cookie名称和值的字典对象；</li>
<li>files：与上传文件有关的数据；</li>
<li>method：当前的请求方法</li>
</ul>
<h2 id="Web表单"><a href="#Web表单" class="headerlink" title="Web表单"></a>Web表单</h2><p>web表单是web应用程序的基本功能。在Flask中，为了处理web表单，我们一般使用Flask-WTF扩展，它封装了WTForms，并且有验证表单数据的功能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> curses <span class="keyword">import</span> flash</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="comment"># request对象，里面包含请求的信息，包括请求方式</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="comment"># 获取表单数据</span></span><br><span class="line">        form = request.form</span><br><span class="line">        username = form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(password)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">all</span>([username, password]):</span><br><span class="line">            <span class="comment"># print(&#x27;参数不完整&#x27;)</span></span><br><span class="line">            <span class="comment"># 使用消息闪现</span></span><br><span class="line">            flash(<span class="string">&#x27;参数不完整&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> password != <span class="string">&#x27;123&#x27;</span>:</span><br><span class="line">            <span class="comment"># print(&#x27;密码错误...&#x27;)</span></span><br><span class="line">            flash(<span class="string">&#x27;密码错误!&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;success&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>

<h3 id="消息闪现flash"><a href="#消息闪现flash" class="headerlink" title="消息闪现flash"></a>消息闪现flash</h3><p>在上面的栗子中，我们使用了flash，它代替了print语句，也可以传递消息。</p>
<ul>
<li>视图函数中，我们使用flash，其中参数就是消息内容字符串</li>
<li>模板中，使用for循环遍历获取闪现消息</li>
</ul>
<h2 id="表单数据发送到模板"><a href="#表单数据发送到模板" class="headerlink" title="表单数据发送到模板"></a>表单数据发送到模板</h2><h3 id="原生写法"><a href="#原生写法" class="headerlink" title="原生写法"></a>原生写法</h3><p>有了前面的知识点，我们接下来研究如何将表单数据发送到模板。<br>我们的案例中，准备了两个模板文件student.html(收集表单数据)、result.html(展现收集到的表单数据，以表格形式)。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- student.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://localhost:5000/result&quot;</span> <span class="attr">method</span>=<span class="string">&quot;POST&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Name <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Name&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Physics <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Physics&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Chemistry <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;chemistry&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>Maths <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;Mathematics&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 首先进入/ URL页面，呈现具有表单的网页</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">student</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;student.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/result&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">result</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="comment"># 收集字典对象中的request.form中的表单数据，并给result.html</span></span><br><span class="line">        result = request.form</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;result.html&#x27;</span>, result=result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p>由于student()绑定到URL &#x2F;页面下，因此首先展示的就是student()中渲染的student.html文件，即展示表单；<br>而一旦有提交表单的POST请求，就会将请求中的表单数据给模板result.html来渲染。<br>result.html文件如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">1</span>&gt;</span></span><br><span class="line">        &#123;% for key, value in result.items() %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span> &#123;&#123; key &#125;&#125; <span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span> &#123;&#123; value &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="WTF"><a href="#WTF" class="headerlink" title="WTF"></a>WTF</h3><h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><p>Flask的WTF表单，提供了更加方便的写法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, flash</span><br><span class="line"><span class="keyword">from</span> flask_wtf <span class="keyword">import</span> FlaskForm</span><br><span class="line"><span class="keyword">from</span> wtforms <span class="keyword">import</span> StringField, PasswordField, SubmitField</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="string">&#x27;itheima&#x27;</span>  <span class="comment"># 设置加密密钥</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">使用WTF实现表单</span></span><br><span class="line"><span class="string">自定义一个表单类LoginForm</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoginForm</span>(<span class="title class_ inherited__">FlaskForm</span>):</span><br><span class="line">    username = StringField(<span class="string">u&#x27;用户名:&#x27;</span>)</span><br><span class="line">    password = PasswordField(<span class="string">u&#x27;密码:&#x27;</span>)</span><br><span class="line">    submit = SubmitField(<span class="string">u&#x27;提交:&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    login_form = LoginForm()</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;wtf.html&#x27;</span>, form=login_form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>模板文件wtf.html内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;X-UA-Compatible&quot;</span> <span class="attr">content</span>=<span class="string">&quot;IE=edge&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        &#123;&#123; form.username.label &#125;&#125; &#123;&#123; form.username &#125;&#125;</span><br><span class="line">        &#123;&#123; form.password.label &#125;&#125; &#123;&#123; form.password &#125;&#125;</span><br><span class="line">        &#123;&#123; form.submit.label &#125;&#125; &#123;&#123; form.submit &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在视图函数所在的.py文件，导入所需要的库之后，需要单独定一个类，并定义出表单所有项，然后将该类的实例对象给渲染函数，便于模板文件中使用。<br>在模板文件中，我们用FlaskForm继承类的表单项来获取相应的组件，通过其label属性来获取文本标签。可见上面.html栗子。</p>
<h4 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启wtf验证</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    login_form = LoginForm()</span><br><span class="line">    <span class="comment"># 判断请求方式</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        <span class="comment"># 获取请求参数</span></span><br><span class="line">        form = request.form</span><br><span class="line">        username = form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        <span class="comment"># 验证参数，WTF可以一句话实现所有的校验</span></span><br><span class="line">        <span class="keyword">if</span> login_form.validate_on_submit():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;success!&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            flash(<span class="string">&#x27;参数有误!&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;wtf.html&#x27;</span>, form=login_form)</span><br></pre></td></tr></table></figure>

<h2 id="在Flask中使用数据库"><a href="#在Flask中使用数据库" class="headerlink" title="在Flask中使用数据库"></a>在Flask中使用数据库</h2><h2 id="Flask-Cookie"><a href="#Flask-Cookie" class="headerlink" title="Flask Cookie"></a>Flask Cookie</h2><p>Request对象包含Cookie的属性</p>
<h2 id="Flask-Session"><a href="#Flask-Session" class="headerlink" title="Flask Session"></a>Flask Session</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://luqingbys.github.io/mid-lake-pavilion.github.io/2022/02/06/Flask%E5%9F%BA%E7%A1%80/" data-id="cl17apw1g0007icudhlx8geog" data-title="Flask基础" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-操作系统" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/mid-lake-pavilion.github.io/2022/02/06/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time class="dt-published" datetime="2022-02-06T02:23:51.000Z" itemprop="datePublished">2022-02-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/mid-lake-pavilion.github.io/2022/02/06/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="操作系统——入门"><a href="#操作系统——入门" class="headerlink" title="操作系统——入门"></a>操作系统——入门</h2><p>操作系统（Operating System）—— 是计算机硬件和应用程序之间的一层软件</p>
<p>它最靠近硬件层，用于<br>CPU管理、内存管理、终端管理、磁盘管理、文件管理、网络管理、电源管理、多核管理。</p>
<ul>
<li>CPU调度器</li>
<li>物理内存管理</li>
<li>虚拟内存管理</li>
<li>文件系统管理</li>
</ul>
<p>操作系统形象地看来，就如同政府，本身不能实现任何有用的功能，但是可以提供一个方便其他程序执行的有用的工作环境。</p>
<p>下面我们从两个角度来探讨操作系统。</p>
<h3 id="用户视角"><a href="#用户视角" class="headerlink" title="用户视角"></a>用户视角</h3><p>对于大多数PC机，其操作系统设计的主要目的是为了用户使用方便；<br>对于大型机或者小型机，操作系统的设计目标是优化资源利用率。</p>
<h3 id="系统角度"><a href="#系统角度" class="headerlink" title="系统角度"></a>系统角度</h3><p>操作系统是资源分配器，调度CPU时间、内存空间、文件存储空间、I&#x2F;O设备等。</p>
<h2 id="操作系统的启动"><a href="#操作系统的启动" class="headerlink" title="操作系统的启动"></a>操作系统的启动</h2><ul>
<li>计算机刚开机时，操作系统存放在磁盘disk上</li>
<li>开机后，基本I&#x2F;O处理系统（简称BIOS）可以让计算机系统检测各种各样的外设</li>
<li>Bootloader将操作系统的代码和数据从硬盘加载到内存中，接下来跳转到操作系统的起始地址</li>
</ul>
<h2 id="操作系统的interface"><a href="#操作系统的interface" class="headerlink" title="操作系统的interface"></a>操作系统的interface</h2><p>一般来说，操作系统需要和外设和应用程序打交道。<br>操作系统与外设：中断技术<br>操作系统与应用程序：系统调用、异常</p>
<p>下面分别简要介绍这三种接口。</p>
<ul>
<li>系统调用（sys call）：应用程序主动向操作系统发出服务请求，来源于应用程序</li>
<li>异常：非法指令或者其他不良处理状态，来源于不良的应用程序</li>
<li>中断：来自不同的硬件设备的计时器和网络中断，来源于外设（键盘、鼠标等），它是一个相对持续的过程，对于用户来说是透明的，也就是说用户一般是察觉不到的。</li>
</ul>
<h3 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h3><p>中断——外设事件，一般需要硬件和软件两方面参与。<br>硬件：设置中断标记（报价将中断事件设置中断标记、记下中断事件的ID）<br>软件：保存当前处理状态、中断服务程序处理、清除中断标记</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://luqingbys.github.io/mid-lake-pavilion.github.io/2022/02/06/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" data-id="cl17apw2h002bicud7fvdh340" data-title="操作系统" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/mid-lake-pavilion.github.io/">&laquo; Prev</a><a class="page-number" href="/mid-lake-pavilion.github.io/">1</a><span class="page-number current">2</span><a class="page-number" href="/mid-lake-pavilion.github.io/page/3/">3</a><a class="page-number" href="/mid-lake-pavilion.github.io/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/mid-lake-pavilion.github.io/page/8/">8</a><a class="extend next" rel="next" href="/mid-lake-pavilion.github.io/page/3/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/CF/">CF</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/Java%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/">Java程序设计</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/Web%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80/">Web前端基础</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/%E5%89%8D%E7%AB%AF%E4%B9%8B%E8%B7%AF/">前端之路</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/%E5%A4%9A%E4%B8%80%E7%82%B9%E5%86%A5%E6%83%B3/">多一点冥想</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/">数字逻辑设计</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F/">数据库系统</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/%E8%8A%B1%E9%97%B4%E4%B8%80%E5%A3%B6%E9%85%92/">花间一壶酒</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90%E5%8E%9F%E7%90%86/">计算机组成原理</a></li><li class="category-list-item"><a class="category-list-link" href="/mid-lake-pavilion.github.io/categories/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E5%BB%BA%E6%A8%A1%E6%8A%80%E6%9C%AF/">面向对象建模技术</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/mid-lake-pavilion.github.io/tags/%E5%A4%A7%E5%AD%A6%E8%AF%BE%E7%A8%8B/" rel="tag">大学课程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/mid-lake-pavilion.github.io/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" rel="tag">浏览器</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/mid-lake-pavilion.github.io/tags/%E5%A4%A7%E5%AD%A6%E8%AF%BE%E7%A8%8B/" style="font-size: 20px;">大学课程</a> <a href="/mid-lake-pavilion.github.io/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" style="font-size: 10px;">浏览器</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/mid-lake-pavilion.github.io/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/mid-lake-pavilion.github.io/archives/2022/02/">February 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/mid-lake-pavilion.github.io/archives/2022/01/">January 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/mid-lake-pavilion.github.io/archives/2021/12/">December 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/mid-lake-pavilion.github.io/archives/2021/11/">November 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/mid-lake-pavilion.github.io/archives/2021/10/">October 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/mid-lake-pavilion.github.io/2022/03/26/SQL%E6%9F%A5%E8%AF%A2%E8%AF%AD%E8%A8%80/">(no title)</a>
          </li>
        
          <li>
            <a href="/mid-lake-pavilion.github.io/2022/03/26/hello/">hello</a>
          </li>
        
          <li>
            <a href="/mid-lake-pavilion.github.io/2022/03/26/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/mid-lake-pavilion.github.io/2022/03/26/%E6%A6%82%E5%BF%B5%E7%BB%93%E6%9E%84%E8%AE%BE%E8%AE%A1/">概念结构设计</a>
          </li>
        
          <li>
            <a href="/mid-lake-pavilion.github.io/2022/03/24/JavaScript%E7%9A%84%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">JavaScript的正则表达式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/mid-lake-pavilion.github.io/" class="mobile-nav-link">Home</a>
  
    <a href="/mid-lake-pavilion.github.io/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/mid-lake-pavilion.github.io/js/jquery-3.4.1.min.js"></script>



  
<script src="/mid-lake-pavilion.github.io/fancybox/jquery.fancybox.min.js"></script>




<script src="/mid-lake-pavilion.github.io/js/script.js"></script>





  </div>
</body>
</html>